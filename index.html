<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance √Çg√©e OL - Syst√®me Collaboratif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        .comment-badge {
            background: #fbbf24;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .comment-badge:hover {
            background: #f59e0b;
        }
        .comment-item {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #3b82f6;
            position: relative;
        }
        .comment-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .comment-delete-btn:hover {
            background: #dc2626;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- √âCRAN DE CONNEXION -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-m          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
              <div class="text-center mb-8">
                  <h1 class="text-3xl font-bold text-gray-800 mb-2">Balance √Çg√©e OL</h1>
                  <p class="text-gray-600">Syst√®me Collaboratif de Gestion</p>
              </div>
              
              <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email professionnel</label>
                  <input 
                      type="email" 
                      id="emailInput" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="votre.nom@olympiclocation.com"
                  >
              </div>
              
              <button 
                  onclick="seConnecter()" 
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl"
              >
                  Se connecter
              </button>
              
              <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
              <div id="loginLoading" class="mt-4 text-center text-gray-600 hidden">
                  <div class="animate-pulse">Connexion en cours...</div>
              </div>
          </div>
      </div>

      <!-- √âCRAN PRINCIPAL -->
      <div id="mainScreen" class="hidden">
          
          <!-- HEADER -->
          <header class="bg-white shadow-md no-print">
              <div class="container mx-auto px-4 py-4">
                  <div class="flex justify-between items-center">
                      <div>
                          <h1 class="text-2xl font-bold text-gray-800">Balance √Çg√©e OL</h1>
                          <p class="text-sm text-gray-600">Bienvenue, <span id="userName" class="font-semibold"></span></p>
                      </div>
                      <div class="flex items-center gap-4">
                          <div class="text-right text-sm">
                              <div class="text-gray-600">Agences:</div>
                              <div id="userAgences" class="font-semibold text-blue-600"></div>
                          </div>
                          <button 
                              onclick="seDeconnecter()" 
                              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition"
                          >
                              D√©connexion
                          </button>
                      </div>
                  </div>
              </div>
          </header>

          <!-- NAVIGATION -->
          <nav class="bg-white border-b border-gray-200 no-print">
              <div class="container mx-auto px-4">
                  <div class="flex space-x-1">
                      <button onclick="changerOnglet('import')" id="tab-import" class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 transition">
                          üì§ Import
                      </button>
                      <button onclick="changerOnglet('analyse')" id="tab-analyse" class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 transition">
                          üìä Analyse
                      </button>
                      <button onclick="changerOnglet('historique')" id="tab-historique" class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 transition">
                          üìú Historique
                      </button>
                  </div>
              </div>
          </nav>

          <!-- CONTENU -->
          <main class="container mx-auto px-4 py-6">
              
              <!-- ONGLET IMPORT -->
              <div id="content-import" class="hidden">
                  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                      <h2 class="text-xl font-bold text-gray-800 mb-4">üì§ Importer une Balance √Çg√©e</h2>
                      
                      <div class="mb-4">
                          <label class="block text-sm font-medium text-gray-700 mb-2">S√©lectionnez l'agence</label>
                          <select id="agenceSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                              <option value="">-- Choisir une agence --</option>
                          </select>
                      </div>
                      
                      <div 
                          id="dropZone" 
                          class="drop-zone rounded-xl p-12 text-center cursor-pointer bg-gray-50 hover:bg-blue-50 transition"
                      >
                          <div class="text-6xl mb-4">üìÅ</div>
                          <p class="text-lg font-semibold text-gray-700 mb-2">Glissez votre fichier Excel ici</p>
                          <p class="text-sm text-gray-500 mb-4">ou cliquez pour parcourir</p>
                          <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                          <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                              Parcourir
                          </button>
                      </div>
                      
                      <div id="importStatus" class="mt-4 hidden"></div>
                  </div>
              </div>

              <!-- ONGLET ANALYSE -->
              <div id="content-analyse" class="hidden">
                  
                  <!-- FILTRES -->
                  <div class="bg-white rounded-xl shadow-lg p-6 mb-6 no-print">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
                              <select id="filterAgence" onchange="chargerVersions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                  <option value="">Toutes les agences</option>
                              </select>
                          </div>
                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                              <select id="filterVersion" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                  <option value="latest">Derni√®re version</option>
                              </select>
                          </div>
                          <div class="flex items-end">
                              <button onclick="chargerBalances()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                  üîç Charger
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- STATISTIQUES -->
                  <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <div class="text-sm text-gray-600 mb-1">Total Clients</div>
                          <div id="statClients" class="text-3xl font-bold text-blue-600">0</div>
                      </div>
                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <div class="text-sm text-gray-600 mb-1">Solde Total</div>
                          <div id="statSolde" class="text-3xl font-bold text-green-600">0 ‚Ç¨</div>
                      </div>
                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <div class="text-sm text-gray-600 mb-1">Cr√©ances > 90j</div>
                          <div id="statCreances90" class="text-3xl font-bold text-red-600">0 ‚Ç¨</div>
                      </div>
                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <div class="text-sm text-gray-600 mb-1">Paiements</div>
                          <div id="statPaiements" class="text-3xl font-bold text-purple-600">0 ‚Ç¨</div>
                      </div>
                  </div>

                  <!-- GRAPHIQUE -->
                  <div id="chartContainer" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
                      <h3 class="text-lg font-bold text-gray-800 mb-4">üìä R√©partition des √âch√©ances</h3>
                      <canvas id="echeancesChart"></canvas>
                  </div>

                  <!-- TABLEAU -->
                  <div id="tableContainer" class="bg-white rounded-xl shadow-lg p-6 hidden">
                      <div class="flex justify-between items-center mb-4 no-print">
                          <h3 class="text-lg font-bold text-gray-800">üìã Liste des Clients</h3>
                          <div class="flex gap-2">
                              <button onclick="exporterExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                                  üì• Excel
                              </button>
                              <button onclick="window.print()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                                  üñ®Ô∏è Imprimer
                              </button>
                          </div>
                      </div>
                      <div class="overflow-x-auto">
                          <table id="balanceTable" class="w-full text-sm">
                              <thead class="bg-gray-100">
                                  <tr>
                                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Code</th>
                                      <th class="px-4 py-3 text-left font-semibold text-gray-700">Nom Client</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">Solde</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">0-30j</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">30-60j</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">60-90j</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">90-120j</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">>120j</th>
                                      <th class="px-4 py-3 text-right font-semibold text-gray-700">Paiement</th>
                                      <th class="px-4 py-3 text-center font-semibold text-gray-700 no-print">Commentaires</th>
                                  </tr>
                              </thead>
                              <tbody id="balanceTableBody">
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <!-- ONGLET HISTORIQUE -->
              <div id="content-historique" class="hidden">
                  <div class="bg-white rounded-xl shadow-lg p-6">
                      <h2 class="text-xl font-bold text-gray-800 mb-4">üìú Historique des Imports</h2>
                      <div id="historiqueContainer">
                          <p class="text-gray-600">Chargement...</p>
                      </div>
                  </div>
              </div>

          </main>
      </div>

      <!-- MODAL COMMENTAIRES -->
      <div id="commentModal" class="modal">
          <div class="modal-content">
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold text-gray-800">üí¨ Commentaires</h3>
                  <button onclick="fermerModalCommentaire()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              
              <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                  <div class="font-semibold text-gray-800" id="modalClientNom"></div>
                  <div class="text-sm text-gray-600" id="modalClientCode"></div>
              </div>

              <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Ajouter un commentaire</label>
                  <textarea 
                      id="commentaireInput" 
                      rows="3" 
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="Votre commentaire..."
                  ></textarea>
                  <button onclick="ajouterCommentaire()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                      ‚ûï Ajouter
                  </button>
              </div>

              <div class="border-t pt-4">
                  <h4 class="font-semibold text-gray-800 mb-3">Historique des commentaires</h4>
                  <div id="commentairesList">
                      <p class="text-gray-500 text-sm">Aucun commentaire</p>
                  </div>
              </div>
          </div>
      </div>

      <script>
          // ============================================
          // CONFIGURATION
          // ============================================
          const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyEvVGraEnWnGLB_Kb0lMh_iN4O56L4BoG157RrXKjSbyWDLe4mIQkgM0EtSdOdBQc/exec';
          
          const AGENCES_MAP = {
              '00': 'G√®ze',
              '01': '5 Av',
              '02': 'Gare St Charles',
              '03': 'Aubagne',
              '06': 'La Valentine',
              '09': 'Plombi√®res',
              '12': 'La Garde',
              '13': 'La Ciotat',
              '08': 'Toulon'
          };

          let currentUser = null;
          let currentBalances = [];
          let currentClient = null;
          let chartInstance = null;

          // ============================================
          // AUTHENTIFICATION
          // ============================================
          
          async function seConnecter() {
              const email = document.getElementById('emailInput').value.trim();
              
              if (!email) {
                  afficherErreurLogin('Veuillez entrer votre email');
                  return;
              }

              document.getElementById('loginLoading').classList.remove('hidden');
              document.getElementById('loginError').classList.add('hidden');

              try {
                  const response = await fetch(`${SCRIPT_URL}?action=authentifier&email=${encodeURIComponent(email)}`);
                  const data = await response.json();

                  if (data.success) {
                      currentUser = data;
                      localStorage.setItem('balanceOL_user', JSON.stringify(data));
                      afficherEcranPrincipal();
                  } else {
                      afficherErreurLogin(data.message);
                  }
              } catch (error) {
                  afficherErreurLogin('Erreur de connexion: ' + error.message);
              } finally {
                  document.getElementById('loginLoading').classList.add('hidden');
              }
          }

          function afficherErreurLogin(message) {
              const errorDiv = document.getElementById('loginError');
              errorDiv.textContent = message;
              errorDiv.classList.remove('hidden');
          }

          function afficherEcranPrincipal() {
              document.getElementById('loginScreen').classList.add('hidden');
              document.getElementById('mainScreen').classList.remove('hidden');
              
              document.getElementById('userName').textContent = currentUser.nom;
              document.getElementById('userAgences').textContent = currentUser.agences;
              
              initialiserAgences();
              changerOnglet('import');
          }

          function seDeconnecter() {
              localStorage.removeItem('balanceOL_user');
              currentUser = null;
              location.reload();
          }

          function initialiserAgences() {
              const agenceSelect = document.getElementById('agenceSelect');
              const filterAgence = document.getElementById('filterAgence');
              
              agenceSelect.innerHTML = '<option value="">-- Choisir une agence --</option>';
              filterAgence.innerHTML = '<option value="">Toutes les agences</option>';
              
              let agences = [];
              if (currentUser.agences === 'Toutes les agences') {
                  agences = Object.values(AGENCES_MAP);
              } else {
                  agences = currentUser.agences.split(';').map(a => a.trim());
              }
              
              agences.forEach(agence => {
                  agenceSelect.innerHTML += `<option value="${agence}">${agence}</option>`;
                  filterAgence.innerHTML += `<option value="${agence}">${agence}</option>`;
              });
          }

          // ============================================
          // NAVIGATION
          // ============================================
          
          function changerOnglet(onglet) {
              // Masquer tous les contenus
              document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
              document.querySelectorAll('[id^="tab-"]').forEach(el => {
                  el.classList.remove('border-blue-600', 'text-blue-600');
                  el.classList.add('border-transparent', 'text-gray-600');
              });
              
              // Afficher le contenu s√©lectionn√©
              document.getElementById('content-' + onglet).classList.remove('hidden');
              const tab = document.getElementById('tab-' + onglet);
              tab.classList.add('border-blue-600', 'text-blue-600');
              tab.classList.remove('border-transparent', 'text-gray-600');
              
              if (onglet === 'historique') {
                  chargerHistorique();
              }
          }

          // ============================================
          // IMPORT DE FICHIER
          // ============================================
          
          const dropZone = document.getElementById('dropZone');
          const fileInput = document.getElementById('fileInput');

          dropZone.addEventListener('click', () => fileInput.click());
          
          dropZone.addEventListener('dragover', (e) => {
              e.preventDefault();
              dropZone.classList.add('dragover');
          });
          
          dropZone.addEventListener('dragleave', () => {
              dropZone.classList.remove('dragover');
          });
          
          dropZone.addEventListener('drop', (e) => {
              e.preventDefault();
              dropZone.classList.remove('dragover');
              const file = e.dataTransfer.files[0];
              if (file) traiterFichier(file);
          });
          
          fileInput.addEventListener('change', (e) => {
              const file = e.target.files[0];
              if (file) traiterFichier(file);
          });

          async function traiterFichier(file) {
              const agence = document.getElementById('agenceSelect').value;
              
              if (!agence) {
                  afficherStatutImport('error', 'Veuillez s√©lectionner une agence');
                  return;
              }

              afficherStatutImport('loading', 'Lecture du fichier...');

              try {
                  const data = await lireFichierExcel(file);
                  const clients = parserBalanceAgee(data, agence);
                  
                  if (clients.length === 0) {
                      afficherStatutImport('error', 'Aucun client trouv√© dans le fichier');
                      return;
                  }

                  afficherStatutImport('loading', `${clients.length} clients trouv√©s. Envoi au serveur...`);
                  
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      body: JSON.stringify({
                          action: 'importerBalance',
                          data: clients,
                          agence: agence,
                          email: currentUser.email,
                          nom: currentUser.nom
                      })
                  });

                  const result = await response.json();

                  if (result.success) {
                      afficherStatutImport('success', `‚úÖ ${result.message}<br>Version: ${result.version}`);
                      setTimeout(() => changerOnglet('analyse'), 2000);
                  } else {
                      afficherStatutImport('error', result.message);
                  }

              } catch (error) {
                  afficherStatutImport('error', 'Erreur: ' + error.message);
              }
          }

          function lireFichierExcel(file) {
              return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      try {
                          const data = new Uint8Array(e.target.result);
                          const workbook = XLSX.read(data, { type: 'array' });
                          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                          resolve(jsonData);
                      } catch (error) {
                          reject(error);
                      }
                  };
                  reader.onerror = reject;
                  reader.readAsArrayBuffer(file);
              });
          }

          function parserBalanceAgee(data, agence) {
              const clients = [];
              let headerRow = -1;

              // Trouver la ligne d'en-t√™te
              for (let i = 0; i < Math.min(10, data.length); i++) {
                  const row = data[i];
                  if (row.some(cell => cell && cell.toString().toLowerCase().includes('compte'))) {
                      headerRow = i;
                      break;
                  }
              }

              if (headerRow === -1) {
                  throw new Error('En-t√™tes non trouv√©s dans le fichier');
              }

              // Parser les donn√©es
              for (let i = headerRow + 1; i < data.length; i++) {
                  const row = data[i];
                  
                  if (!row[0] || !row[1]) continue;

                  const codeClient = row[0].toString().trim();
                  const nomClient = row[1].toString().trim();

                  // Extraire les valeurs num√©riques
                  const echeancePlus120 = parseFloat(row[2]) || 0;
                  const echeance90 = parseFloat(row[3]) || 0;
                  const echeance60 = parseFloat(row[4]) || 0;
                  const echeance30 = parseFloat(row[5]) || 0;
                  const echeance0 = parseFloat(row[6]) || 0;
                  const paiement = parseFloat(row[7]) || 0;
                  const solde = parseFloat(row[8]) || 0;

                  clients.push({
                      codeClient,
                      nomClient,
                      solde,
                      echeance0,
                      echeance30,
                      echeance60,
                      echeance90,
                      echeancePlus120,
                      paiement
                  });
              }

              console.log(`‚úÖ ${clients.length} clients pars√©s avec succ√®s`);
              return clients;
          }

          function afficherStatutImport(type, message) {
              const statusDiv = document.getElementById('importStatus');
              statusDiv.classList.remove('hidden');
              
              const colors = {
                  loading: 'bg-blue-100 border-blue-400 text-blue-700',
                  success: 'bg-green-100 border-green-400 text-green-700',
                  error: 'bg-red-100 border-red-400 text-red-700'
              };
              
              statusDiv.className = `mt-4 p-4 border rounded-lg ${colors[type]}`;
              statusDiv.innerHTML = message;
          }

          // ============================================
          // CHARGEMENT DES BALANCES
          // ============================================
          
          async function chargerVersions() {
              const agence = document.getElementById('filterAgence').value;
              const versionSelect = document.getElementById('filterVersion');
              
              try {
                  const agences = agence || currentUser.agences;
                  const response = await fetch(`${SCRIPT_URL}?action=getVersionsDisponibles&agences=${encodeURIComponent(agences)}`);
                  const data = await response.json();

                  if (data.success) {
                      versionSelect.innerHTML = '<option value="latest">Derni√®re version</option>';
                      
                      const versions = agence ? data.versions[agence] : Object.values(data.versions).flat();
                      const uniqueVersions = [...new Set(versions.map(v => v.version))];
                      
                      uniqueVersions.forEach(v => {
                          versionSelect.innerHTML += `<option value="${v}">${v}</option>`;
                      });
                  }
              } catch (error) {
                  console.error('Erreur chargement versions:', error);
              }
          }

          async function chargerBalances() {
              const agence = document.getElementById('filterAgence').value;
              const version = document.getElementById('filterVersion').value;
              
              try {
                  const agences = agence || currentUser.agences;
                  const response = await fetch(`${SCRIPT_URL}?action=getBalances&agences=${encodeURIComponent(agences)}&version=${version}`);
                  const data = await response.json();

                  if (data.success) {
                      currentBalances = data.data;
                      afficherBalances(currentBalances);
                  }
              } catch (error) {
                  console.error('Erreur chargement balances:', error);
              }
          }

          function afficherBalances(balances) {
              // Afficher les conteneurs
              document.getElementById('statsContainer').classList.remove('hidden');
              document.getElementById('chartContainer').classList.remove('hidden');
              document.getElementById('tableContainer').classList.remove('hidden');

              // Calculer les statistiques
              const stats = {
                  clients: balances.length,
                  solde: balances.reduce((sum, b) => sum + b.solde, 0),
                  creances90: balances.reduce((sum, b) => sum + b.echeance90 + b.echeancePlus120, 0),
                  paiements: balances.reduce((sum, b) => sum + b.paiement, 0)
              };

              document.getElementById('statClients').textContent = stats.clients;
              document.getElementById('statSolde').textContent = formatEuro(stats.solde);
              document.getElementById('statCreances90').textContent = formatEuro(stats.creances90);
              document.getElementById('statPaiements').textContent = formatEuro(stats.paiements);

              // Afficher le graphique
              afficherGraphique(balances);

              // Afficher le tableau
              const tbody = document.getElementById('balanceTableBody');
              tbody.innerHTML = '';

              balances.forEach(balance => {
                  const row = document.createElement('tr');
                  row.className = 'border-b hover:bg-gray-50';
                  row.innerHTML = `
                      <td class="px-4 py-3">${balance.codeClient}</td>
                      <td class="px-4 py-3">${balance.nomClient}</td>
                      <td class="px-4 py-3 text-right font-semibold">${formatEuro(balance.solde)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.echeance0)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.echeance30)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.echeance60)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.echeance90)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.echeancePlus120)}</td>
                      <td class="px-4 py-3 text-right">${formatEuro(balance.paiement)}</td>
                      <td class="px-4 py-3 text-center no-print">
                          <button onclick="ouvrirModalCommentaire('${balance.codeClient}', '${balance.nomClient}', '${balance.agence}')" class="comment-badge">
                              üí¨ Voir
                          </button>
                      </td>
                  `;
                  tbody.appendChild(row);
              });
          }

          function afficherGraphique(balances) {
                            const ctx = document.getElementById('echeancesChart').getContext('2d');

              // D√©truire l'ancien graphique s'il existe
              if (chartInstance) {
                  chartInstance.destroy();
              }

              // Calculer les totaux par √©ch√©ance
              const totaux = {
                  echeance0: balances.reduce((sum, b) => sum + b.echeance0, 0),
                  echeance30: balances.reduce((sum, b) => sum + b.echeance30, 0),
                  echeance60: balances.reduce((sum, b) => sum + b.echeance60, 0),
                  echeance90: balances.reduce((sum, b) => sum + b.echeance90, 0),
                  echeancePlus120: balances.reduce((sum, b) => sum + b.echeancePlus120, 0)
              };

              chartInstance = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: ['0-30j', '30-60j', '60-90j', '90-120j', '>120j'],
                      datasets: [{
                          label: 'Montant (‚Ç¨)',
                          data: [
                              totaux.echeance0,
                              totaux.echeance30,
                              totaux.echeance60,
                              totaux.echeance90,
                              totaux.echeancePlus120
                          ],
                          backgroundColor: [
                              'rgba(34, 197, 94, 0.7)',
                              'rgba(59, 130, 246, 0.7)',
                              'rgba(251, 191, 36, 0.7)',
                              'rgba(249, 115, 22, 0.7)',
                              'rgba(239, 68, 68, 0.7)'
                          ],
                          borderColor: [
                              'rgb(34, 197, 94)',
                              'rgb(59, 130, 246)',
                              'rgb(251, 191, 36)',
                              'rgb(249, 115, 22)',
                              'rgb(239, 68, 68)'
                          ],
                          borderWidth: 2
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      plugins: {
                          legend: {
                              display: false
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      return formatEuro(context.parsed.y);
                                  }
                              }
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              ticks: {
                                  callback: function(value) {
                                      return formatEuro(value);
                                  }
                              }
                          }
                      }
                  }
              });
          }

          // ============================================
          // COMMENTAIRES
          // ============================================
          
          async function ouvrirModalCommentaire(codeClient, nomClient, agence) {
              currentClient = { codeClient, nomClient, agence };
              
              document.getElementById('modalClientCode').textContent = codeClient;
              document.getElementById('modalClientNom').textContent = nomClient;
              document.getElementById('commentaireInput').value = '';
              
              document.getElementById('commentModal').classList.add('active');
              
              await chargerCommentaires();
          }

          function fermerModalCommentaire() {
              document.getElementById('commentModal').classList.remove('active');
              currentClient = null;
          }

          async function chargerCommentaires() {
              if (!currentClient) return;

              try {
                  const response = await fetch(`${SCRIPT_URL}?action=getCommentaires&codeClient=${encodeURIComponent(currentClient.codeClient)}&agence=${encodeURIComponent(currentClient.agence)}`);
                  const data = await response.json();

                  const container = document.getElementById('commentairesList');

                  if (data.success && data.data.length > 0) {
                      container.innerHTML = '';
                      data.data.forEach(comment => {
                          const div = document.createElement('div');
                          div.className = 'comment-item';
                          
                          const canDelete = comment.email === currentUser.email;
                          
                          div.innerHTML = `
                              ${canDelete ? `<button onclick="supprimerCommentaire('${comment.id}')" class="comment-delete-btn">üóëÔ∏è</button>` : ''}
                              <div class="author">${comment.auteur}</div>
                              <div class="timestamp">${comment.date} √† ${comment.heure}</div>
                              <div class="text">${comment.commentaire}</div>
                          `;
                          container.appendChild(div);
                      });
                  } else {
                      container.innerHTML = '<p class="text-gray-500 text-sm">Aucun commentaire</p>';
                  }
              } catch (error) {
                  console.error('Erreur chargement commentaires:', error);
              }
          }

          async function ajouterCommentaire() {
              const commentaire = document.getElementById('commentaireInput').value.trim();
              
              if (!commentaire) {
                  alert('Veuillez saisir un commentaire');
                  return;
              }

              try {
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      body: JSON.stringify({
                          action: 'ajouterCommentaire',
                          codeClient: currentClient.codeClient,
                          nomClient: currentClient.nomClient,
                          commentaire: commentaire,
                          auteur: {
                              nom: currentUser.nom,
                              email: currentUser.email
                          },
                          agence: currentClient.agence
                      })
                  });

                  const data = await response.json();

                  if (data.success) {
                      document.getElementById('commentaireInput').value = '';
                      await chargerCommentaires();
                  } else {
                      alert('Erreur: ' + data.message);
                  }
              } catch (error) {
                  alert('Erreur: ' + error.message);
              }
          }

          async function supprimerCommentaire(commentaireId) {
              if (!confirm('Supprimer ce commentaire ?')) return;

              try {
                  const response = await fetch(SCRIPT_URL, {
                      method: 'POST',
                      body: JSON.stringify({
                          action: 'supprimerCommentaire',
                          commentaireId: commentaireId,
                          email: currentUser.email
                      })
                  });

                  const data = await response.json();

                  if (data.success) {
                      await chargerCommentaires();
                  } else {
                      alert('Erreur: ' + data.message);
                  }
              } catch (error) {
                  alert('Erreur: ' + error.message);
              }
          }

          // ============================================
          // HISTORIQUE
          // ============================================
          
          async function chargerHistorique() {
              const container = document.getElementById('historiqueContainer');
              container.innerHTML = '<p class="text-gray-600">Chargement...</p>';

              try {
                  const response = await fetch(`${SCRIPT_URL}?action=getVersionsDisponibles&agences=${encodeURIComponent(currentUser.agences)}`);
                  const data = await response.json();

                  if (data.success) {
                      container.innerHTML = '';
                      
                      Object.keys(data.versions).forEach(agence => {
                          if (data.versions[agence].length > 0) {
                              const agenceDiv = document.createElement('div');
                              agenceDiv.className = 'mb-6';
                              
                              let html = `
                                  <h3 class="text-lg font-bold text-gray-800 mb-3">üìç ${agence}</h3>
                                  <div class="space-y-2">
                              `;
                              
                              data.versions[agence].forEach(v => {
                                  html += `
                                      <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                          <div>
                                              <span class="font-semibold text-blue-600">${v.version}</span>
                                              <span class="text-sm text-gray-600 ml-3">par ${v.importePar}</span>
                                          </div>
                                          <div class="text-sm text-gray-600">
                                              ${v.date} √† ${v.heure}
                                          </div>
                                      </div>
                                  `;
                              });
                              
                              html += '</div>';
                              agenceDiv.innerHTML = html;
                              container.appendChild(agenceDiv);
                          }
                      });
                      
                      if (container.innerHTML === '') {
                          container.innerHTML = '<p class="text-gray-600">Aucun historique disponible</p>';
                      }
                  }
              } catch (error) {
                  container.innerHTML = '<p class="text-red-600">Erreur de chargement</p>';
                  console.error('Erreur historique:', error);
              }
          }

          // ============================================
          // EXPORT EXCEL
          // ============================================
          
          function exporterExcel() {
              if (currentBalances.length === 0) {
                  alert('Aucune donn√©e √† exporter');
                  return;
              }

              const data = currentBalances.map(b => ({
                  'Code Client': b.codeClient,
                  'Nom Client': b.nomClient,
                  'Solde': b.solde,
                  '0-30j': b.echeance0,
                  '30-60j': b.echeance30,
                  '60-90j': b.echeance60,
                  '90-120j': b.echeance90,
                  '>120j': b.echeancePlus120,
                  'Paiement': b.paiement,
                  'Agence': b.agence,
                  'Version': b.version
              }));

              const ws = XLSX.utils.json_to_sheet(data);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Balance √Çg√©e');

              const fileName = `Balance_Agee_${new Date().toISOString().split('T')[0]}.xlsx`;
              XLSX.writeFile(wb, fileName);
          }

          // ============================================
          // UTILITAIRES
          // ============================================
          
          function formatEuro(montant) {
              return new Intl.NumberFormat('fr-FR', {
                  style: 'currency',
                  currency: 'EUR'
              }).format(montant);
          }

          // ============================================
          // INITIALISATION
          // ============================================
          
          window.addEventListener('DOMContentLoaded', () => {
              // V√©rifier si l'utilisateur est d√©j√† connect√©
              const savedUser = localStorage.getItem('balanceOL_user');
              if (savedUser) {
                  try {
                      currentUser = JSON.parse(savedUser);
                      afficherEcranPrincipal();
                  } catch (error) {
                      console.error('Erreur restauration session:', error);
                      localStorage.removeItem('balanceOL_user');
                  }
              }

              // Permettre la connexion avec la touche Entr√©e
              document.getElementById('emailInput').addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      seConnecter();
                  }
              });

              // Fermer la modal en cliquant √† l'ext√©rieur
              document.getElementById('commentModal').addEventListener('click', (e) => {
                  if (e.target.id === 'commentModal') {
                      fermerModalCommentaire();
                  }
              });
          });
      </script>
  </body>
  </html>

