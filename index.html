<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Balance √Çg√©e - Olympic Location</title>
  
  <!-- Tailwind CSS via CDN Play (meilleur pour production que cdn.tailwindcss.com) -->
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
  
  <!-- SheetJS pour Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    .tab-active {
      background-color: #3b82f6 !important;
      color: white !important;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    .table-container {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .sticky-header th {
      position: sticky;
      top: 0;
      background-color: #1e40af;
      z-index: 10;
    }
    
    /* Notifications */
    .notification {
      animation: slideIn 0.3s ease;
    }
    
    .notification.slide-out {
      animation: slideOut 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">üìä Balance √Çg√©e</h1>
          <p class="text-blue-200 text-sm">Olympic Location - Gestion des cr√©ances clients</p>
        </div>
        <div id="userInfo" class="text-right hidden">
          <p class="font-semibold" id="userName"></p>
          <p class="text-sm text-blue-200" id="userEmail"></p>
          <button onclick="logout()" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded text-sm transition">
            D√©connexion
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTAINER -->
  <div class="container mx-auto px-4 py-8">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê Connexion</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="emailInput" placeholder="votre.email@olympiclocation.com"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            onkeypress="if(event.key==='Enter') login()">
        </div>
        <button onclick="login()" 
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
          Se connecter
        </button>
        <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
      </div>
      
      <!-- Section de test de connexion -->
      <div class="mt-8 pt-6 border-t border-gray-200">
        <p class="text-sm text-gray-600 mb-3">üîß Tester la connexion API</p>
        <button onclick="testerConnexionInitiale()" 
          class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 rounded-lg transition duration-200 text-sm">
          Tester l'API
        </button>
        <div id="testMessage" class="mt-3 text-sm"></div>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
      
      <!-- TABS -->
      <div class="bg-white rounded-lg shadow-lg mb-6">
        <div class="flex border-b">
          <button onclick="switchTab('import')" id="tab-import" 
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition tab-active">
            üì§ Import
          </button>
          <button onclick="switchTab('consultation')" id="tab-consultation"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            üìã Consultation
          </button>
          <button onclick="switchTab('historique')" id="tab-historique"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            üìú Historique
          </button>
          <button onclick="switchTab('config')" id="tab-config"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            ‚öôÔ∏è Configuration
          </button>
        </div>
      </div>

      <!-- TAB CONTENT: IMPORT -->
      <div id="content-import" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üì§ Import de Balance</h2>
          
          <div class="space-y-6">
            <!-- S√©lection agence -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
              <select id="agenceSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">-- S√©lectionnez une agence --</option>
              </select>
            </div>

            <!-- Upload fichier -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fichier Excel</label>
              <input type="file" id="fileInput" accept=".xlsx,.xls" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Bouton import -->
            <button onclick="importerFichier()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
              üöÄ Importer
            </button>

            <!-- Messages -->
            <div id="importMessage" class="hidden"></div>
            
            <!-- Loader -->
            <div id="importLoader" class="hidden flex justify-center items-center py-8">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: CONSULTATION -->
      <div id="content-consultation" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Consultation des Balances</h2>
          
          <div class="space-y-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
                <select id="consultAgenceSelect" onchange="chargerVersions()" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">-- S√©lectionnez une agence --</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                <select id="versionSelect" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="latest">Derni√®re version</option>
                </select>
              </div>
            </div>
            
            <button onclick="chargerBalance()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
              üìä Charger la balance
            </button>
          </div>

          <!-- R√©sultats -->
          <div id="balanceResults" class="hidden">
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                  <p class="text-sm text-gray-600">Version</p>
                  <p class="text-xl font-bold text-blue-700" id="resultVersion"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Date</p>
                  <p class="text-xl font-bold text-blue-700" id="resultDate"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Clients</p>
                  <p class="text-xl font-bold text-blue-700" id="resultNbClients"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Solde Total</p>
                  <p class="text-xl font-bold text-blue-700" id="resultSoldeTotal"></p>
                </div>
              </div>
            </div>

            <!-- Recherche -->
            <div class="mb-4">
              <input type="text" id="searchInput" placeholder="üîç Rechercher un client..." 
                onkeyup="filtrerClients()"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Tableau -->
            <div class="table-container border rounded-lg">
              <table class="w-full text-sm">
                <thead class="sticky-header text-white">
                  <tr>
                    <th class="px-4 py-3 text-left">Code</th>
                    <th class="px-4 py-3 text-left">Client</th>
                    <th class="px-4 py-3 text-right">Solde</th>
                    <th class="px-4 py-3 text-right">0-29j</th>
                    <th class="px-4 py-3 text-right">30-59j</th>
                    <th class="px-4 py-3 text-right">60-89j</th>
                    <th class="px-4 py-3 text-right">90-119j</th>
                    <th class="px-4 py-3 text-right">+120j</th>
                    <th class="px-4 py-3 text-right">Paiement</th>
                  </tr>
                </thead>
                <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>

          <div id="consultLoader" class="hidden flex justify-center items-center py-8">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: HISTORIQUE -->
      <div id="content-historique" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìú Historique des Imports</h2>
          
          <button onclick="chargerHistorique()" 
            class="mb-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition duration-200">
            üîÑ Actualiser
          </button>

          <div id="historiqueContent" class="space-y-2">
            <!-- Historique dynamique -->
          </div>

          <div id="historiqueLoader" class="hidden flex justify-center items-center py-8">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: CONFIG -->
      <div id="content-config" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Configuration</h2>
          
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">URL de l'API Worker</label>
              <input type="text" id="apiUrlInput" 
                placeholder="https://votre-worker.workers.dev"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="mt-2 text-xs text-gray-500">üí° Trouvez votre URL dans Cloudflare Dashboard ‚Üí Workers & Pages</p>
            </div>

            <div class="flex gap-4">
              <button onclick="sauvegarderConfig()" 
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                üíæ Sauvegarder
              </button>
              <button onclick="testerConnexion()" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                üîå Tester la connexion
              </button>
            </div>

            <div id="configMessage" class="hidden"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
// ============================================
// CONFIGURATION API
// ============================================
const API_CONFIG = {
    // ‚ö†Ô∏è REMPLACEZ PAR VOTRE URL WORKER CLOUDFLARE
    workerUrl: 'https://twilight-resonance-5291.julien-olympiclocation.workers.dev',
    
    agencesMap: {
        '00': 'G√®ze',
        '01': '5 Av',
        '02': 'Gare St Charles',
        '03': 'Aubagne',
        '06': 'La Valentine',
        '08': 'Toulon',
        '09': 'Plombi√®res',
        '12': 'La Garde',
        '13': 'La Ciotat'
    }
};

// √âtat global
let currentUser = null;
let currentAgence = null;
let currentData = null;

// ============================================
// INITIALISATION
// ============================================
window.onload = function() {
  console.log('üöÄ Application d√©marr√©e');
  console.log('üì° URL API:', API_CONFIG.workerUrl);
  
  // Charger config
  const savedUrl = localStorage.getItem('apiUrl');
  if (savedUrl) {
    API_CONFIG.workerUrl = savedUrl;
    document.getElementById('apiUrlInput').value = savedUrl;
    console.log('‚úÖ URL charg√©e depuis localStorage:', savedUrl);
  } else {
    document.getElementById('apiUrlInput').value = API_CONFIG.workerUrl;
  }

  // V√©rifier session
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    console.log('‚úÖ Session restaur√©e:', currentUser.email);
    afficherMainApp();
  }
};

// ============================================
// TEST DE CONNEXION INITIAL
// ============================================
async function testerConnexionInitiale() {
  const testDiv = document.getElementById('testMessage');
  testDiv.innerHTML = '<p class="text-blue-600">üîÑ Test en cours...</p>';
  
  try {
    console.log('üß™ Test de connexion vers:', API_CONFIG.workerUrl);
    
    const response = await fetch(`${API_CONFIG.workerUrl}?action=test`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    console.log('üì• R√©ponse HTTP:', response.status, response.statusText);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('‚úÖ Donn√©es re√ßues:', data);
    
    testDiv.innerHTML = `
      <div class="p-3 bg-green-100 border border-green-400 text-green-700 rounded">
        ‚úÖ Connexion r√©ussie !<br>
        <span class="text-xs">Status: ${data.status || 'OK'}</span>
      </div>
    `;
    
  } catch (error) {
    console.error('‚ùå Erreur de connexion:', error);
    testDiv.innerHTML = `
      <div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded">
        ‚ùå Erreur: ${error.message}<br>
        <span class="text-xs">V√©rifiez l'URL du Worker dans Cloudflare</span>
      </div>
    `;
  }
}

// ============================================
// AUTHENTIFICATION
// ============================================
async function login() {
  const email = document.getElementById('emailInput').value.trim();
  
  if (!email) {
    document.getElementById('loginError').textContent = 'Veuillez entrer votre email';
    document.getElementById('loginError').classList.remove('hidden');
    return;
  }

  try {
    console.log('üîê Tentative de connexion:', email);
    showLoading('Authentification en cours...');
    
    const url = `${API_CONFIG.workerUrl}?action=authentifier&email=${encodeURIComponent(email)}`;
    console.log('üì° URL appel√©e:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    console.log('üì• R√©ponse HTTP:', response.status);
    
    if (!response.ok) {
      throw new Error(`Erreur HTTP ${response.status}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ R√©sultat authentification:', result);
    
    hideLoading();
    
    if (result.success) {
      currentUser = result;
      localStorage.setItem('currentUser', JSON.stringify(result));
      
      document.getElementById('loginError').classList.add('hidden');
      afficherMainApp();
      
      showSuccess(`Bienvenue ${result.nom} !`);
    } else {
      document.getElementById('loginError').textContent = result.message || 'Email non autoris√©';
      document.getElementById('loginError').classList.remove('hidden');
    }
    
  } catch (error) {
    console.error('‚ùå Erreur login:', error);
    hideLoading();
    document.getElementById('loginError').textContent = 'Erreur de connexion : ' + error.message;
    document.getElementById('loginError').classList.remove('hidden');
  }
}

function logout() {
  localStorage.removeItem('currentUser');
  currentUser = null;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('userInfo').classList.add('hidden');
  document.getElementById('emailInput').value = '';
}

function afficherMainApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('userInfo').classList.remove('hidden');
  document.getElementById('userName').textContent = currentUser.nom;
  document.getElementById('userEmail').textContent = currentUser.email;

  // Remplir les selects d'agences
  remplirAgences();
}

function remplirAgences() {
  const agences = currentUser.agencesArray || [];
  const select1 = document.getElementById('agenceSelect');
  const select2 = document.getElementById('consultAgenceSelect');

  select1.innerHTML = '<option value="">-- S√©lectionnez une agence --</option>';
  select2.innerHTML = '<option value="">-- S√©lectionnez une agence --</option>';

  agences.forEach(code => {
    const nom = API_CONFIG.agencesMap[code] || code;
    select1.innerHTML += `<option value="${code}">${code} - ${nom}</option>`;
    select2.innerHTML += `<option value="${code}">${code} - ${nom}</option>`;
  });
}

// ============================================
// GESTION DES ONGLETS
// ============================================
function switchTab(tabName) {
  console.log('üìë Changement d\'onglet:', tabName);
  
  // D√©sactiver tous les onglets
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));

  // Activer l'onglet s√©lectionn√©
  document.getElementById('content-' + tabName).classList.remove('hidden');
  document.getElementById('tab-' + tabName).classList.add('tab-active');
}

// ============================================
// IMPORT DE FICHIER
// ============================================
async function importerFichier() {
  const agence = document.getElementById('agenceSelect').value;
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];

  if (!agence) {
    showMessage('importMessage', 'Veuillez s√©lectionner une agence', 'error');
    return;
  }

  if (!file) {
    showMessage('importMessage', 'Veuillez s√©lectionner un fichier', 'error');
    return;
  }

  document.getElementById('importLoader').classList.remove('hidden');
  document.getElementById('importMessage').classList.add('hidden');

  try {
    const data = await lireFichierExcel(file);
    console.log('üìä Donn√©es Excel pars√©es:', data.metadata);

    if (!data || !data.clients || data.clients.length === 0) {
      throw new Error('Aucune donn√©e valide trouv√©e dans le fichier');
    }

    console.log('üì§ Envoi de', data.clients.length, 'clients pour l\'agence', agence);

    const response = await fetch(API_CONFIG.workerUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'import',
        data: data.clients,
        agence: agence,
        user: currentUser.email,
        metadata: {
          userName: currentUser.nom,
          dateImport: new Date().toISOString()
        }
      })
    });

    const result = await response.json();
    console.log('‚úÖ R√©ponse import:', result);

    if (result.success) {
      showMessage('importMessage', 
        `‚úÖ Import r√©ussi ! ${result.nbClients} clients import√©s (${result.version || 'v1'})`, 
        'success');
      fileInput.value = '';
      showSuccess(`Import termin√© : ${result.nbClients} clients`);
    } else {
      showMessage('importMessage', '‚ùå ' + (result.message || 'Erreur inconnue'), 'error');
    }

  } catch (error) {
    console.error('‚ùå Erreur import:', error);
    showMessage('importMessage', '‚ùå Erreur : ' + error.message, 'error');
  } finally {
    document.getElementById('importLoader').classList.add('hidden');
  }
}

async function lireFichierExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        console.log('üìä Feuilles Excel:', workbook.SheetNames);
        
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
          header: 1,
          defval: '',
          blankrows: false
        });
        
        console.log('üìä Lignes totales:', jsonData.length);
        
        if (jsonData.length < 3) {
          reject(new Error('Fichier vide ou invalide'));
          return;
        }

        // D√©tection des en-t√™tes
        let headerRowIndex = 0;
        for (let i = 0; i < Math.min(5, jsonData.length); i++) {
          const row = jsonData[i];
          const rowStr = row.join('|').toLowerCase();
          
          if (rowStr.includes('compte') && rowStr.includes('intitul√©')) {
            headerRowIndex = i;
            console.log('‚úÖ En-t√™tes ligne', i + 1);
            break;
          }
        }

        const headers = jsonData[headerRowIndex].map(h => 
          String(h || '').toLowerCase().replace(/\s+/g, ' ').replace(/\n/g, ' ').trim()
        );
        
        console.log('üìã En-t√™tes:', headers);

        // Mapping colonnes
        const colonnes = {
          compte: headers.findIndex(h => h.includes('compte')),
          intitule: headers.findIndex(h => h.includes('intitul√©') || h.includes('intitule')),
          solde: headers.findIndex(h => h.includes('solde')),
          e120plus: headers.findIndex(h => h.includes('120') || h.includes('+120')),
          e90_119: headers.findIndex(h => h.includes('90') && h.includes('119')),
          e60_89: headers.findIndex(h => h.includes('60') && h.includes('89')),
          e30_59: headers.findIndex(h => h.includes('30') && h.includes('59')),
           e0_29: headers.findIndex(h => h.includes('0') && h.includes('29')),
          paiement: headers.findIndex(h => h.includes('paiement'))
        };

        console.log('üìä Mapping colonnes:', colonnes);

        // V√©rification colonnes obligatoires
        if (colonnes.compte === -1) {
          reject(new Error('Colonne "Compte" non trouv√©e'));
          return;
        }
        if (colonnes.intitule === -1) {
          reject(new Error('Colonne "Intitul√©" non trouv√©e'));
          return;
        }
        if (colonnes.solde === -1) {
          reject(new Error('Colonne "Solde" non trouv√©e'));
          return;
        }

        const clients = [];
        
        // Parser les donn√©es (apr√®s la ligne d'en-t√™tes)
        for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          
          // Ignorer lignes vides
          if (!row || row.length === 0 || row.every(cell => !cell || cell === '')) {
            continue;
          }
          
          const compte = String(row[colonnes.compte] || '').trim();
          const intitule = String(row[colonnes.intitule] || '').trim();
          
          // Ignorer si pas de compte
          if (!compte || compte === '') {
            continue;
          }

          // Parser montants
          const parseMontant = (val) => {
            if (!val || val === '') return 0;
            const num = parseFloat(String(val).replace(/,/g, '.').replace(/\s/g, ''));
            return isNaN(num) ? 0 : num;
          };

          const solde = parseMontant(row[colonnes.solde]);
          const e0_29 = colonnes.e0_29 !== -1 ? parseMontant(row[colonnes.e0_29]) : 0;
          const e30_59 = colonnes.e30_59 !== -1 ? parseMontant(row[colonnes.e30_59]) : 0;
          const e60_89 = colonnes.e60_89 !== -1 ? parseMontant(row[colonnes.e60_89]) : 0;
          const e90_119 = colonnes.e90_119 !== -1 ? parseMontant(row[colonnes.e90_119]) : 0;
          const e120plus = colonnes.e120plus !== -1 ? parseMontant(row[colonnes.e120plus]) : 0;
          const paiement = colonnes.paiement !== -1 ? parseMontant(row[colonnes.paiement]) : 0;

          const client = {
            code: compte,
            nom: intitule,
            solde: solde,
            e0_29: e0_29,
            e30_59: e30_59,
            e60_89: e60_89,
            e90_119: e90_119,
            e120plus: e120plus,
            paiement: paiement
          };

          clients.push(client);
        }

        console.log('‚úÖ Total clients:', clients.length);

        if (clients.length === 0) {
          reject(new Error('Aucun client valide trouv√©'));
          return;
        }

        resolve({
          clients: clients,
          metadata: {
            nbLignesTotal: jsonData.length,
            nbClients: clients.length,
            headerRow: headerRowIndex + 1
          }
        });

      } catch (error) {
        console.error('‚ùå Erreur parsing:', error);
        reject(error);
      }
    };

    reader.onerror = function(error) {
      reject(error);
    };

    reader.readAsArrayBuffer(file);
  });
}

// ============================================
// CONSULTATION
// ============================================
async function chargerVersions() {
  const agence = document.getElementById('consultAgenceSelect').value;
  if (!agence) return;

  try {
    const response = await fetch(`${API_CONFIG.workerUrl}?action=getVersions&agence=${agence}`);
    const data = await response.json();

    const select = document.getElementById('versionSelect');
    select.innerHTML = '<option value="latest">Derni√®re version</option>';

    if (data.success && data.versions) {
      data.versions.forEach(v => {
        select.innerHTML += `<option value="${v.version}">${v.version} - ${v.date} ${v.heure} (${v.nbClients} clients)</option>`;
      });
    }
  } catch (error) {
    console.error('‚ùå Erreur versions:', error);
  }
}

async function chargerBalance() {
  const agence = document.getElementById('consultAgenceSelect').value;
  const version = document.getElementById('versionSelect').value;

  if (!agence) {
    showError('Veuillez s√©lectionner une agence');
    return;
  }

  document.getElementById('consultLoader').classList.remove('hidden');
  document.getElementById('balanceResults').classList.add('hidden');

  try {
    const response = await fetch(`${API_CONFIG.workerUrl}?action=getBalance&agence=${agence}&version=${version}`);
    const data = await response.json();

    if (data.success) {
      currentData = data.clients;
      currentAgence = agence;
      afficherBalance(data);
    } else {
      showError('Erreur : ' + data.message);
    }
  } catch (error) {
    console.error('‚ùå Erreur balance:', error);
    showError('Erreur de chargement : ' + error.message);
  } finally {
    document.getElementById('consultLoader').classList.add('hidden');
  }
}

function afficherBalance(data) {
  document.getElementById('resultVersion').textContent = data.version;
  document.getElementById('resultDate').textContent = data.dateImport;
  document.getElementById('resultNbClients').textContent = data.nbClients;
  
  const soldeTotal = data.clients.reduce((sum, c) => sum + (c.solde || 0), 0);
  document.getElementById('resultSoldeTotal').textContent = formatMontant(soldeTotal);

  afficherClients(data.clients);
  document.getElementById('balanceResults').classList.remove('hidden');
}

function afficherClients(clients) {
  const tbody = document.getElementById('clientsTableBody');
  tbody.innerHTML = '';

  clients.forEach(client => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50';
    tr.innerHTML = `
      <td class="px-4 py-2 font-mono text-sm">${client.codeClient}</td>
      <td class="px-4 py-2">${client.nomClient}</td>
      <td class="px-4 py-2 text-right font-semibold">${formatMontant(client.solde)}</td>
      <td class="px-4 py-2 text-right">${formatMontant(client.echeance0)}</td>
      <td class="px-4 py-2 text-right">${formatMontant(client.echeance30)}</td>
      <td class="px-4 py-2 text-right">${formatMontant(client.echeance60)}</td>
      <td class="px-4 py-2 text-right">${formatMontant(client.echeance90)}</td>
      <td class="px-4 py-2 text-right text-red-600 font-semibold">${formatMontant(client.echeancePlus120)}</td>
      <td class="px-4 py-2 text-right text-green-600">${formatMontant(client.paiement)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function filtrerClients() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  if (!currentData) return;
  
  const filtered = currentData.filter(c => 
    c.codeClient.toLowerCase().includes(search) || 
    c.nomClient.toLowerCase().includes(search)
  );
  
  afficherClients(filtered);
}

// ============================================
// HISTORIQUE
// ============================================
async function chargerHistorique() {
  document.getElementById('historiqueLoader').classList.remove('hidden');
  
  try {
    const response = await fetch(`${API_CONFIG.workerUrl}?action=getHistorique`);
    const data = await response.json();

    if (data.success) {
      afficherHistorique(data.historique);
    } else {
      showError('Erreur : ' + data.message);
    }
  } catch (error) {
    console.error('‚ùå Erreur historique:', error);
    showError('Erreur de chargement : ' + error.message);
  } finally {
    document.getElementById('historiqueLoader').classList.add('hidden');
  }
}

function afficherHistorique(historique) {
  const container = document.getElementById('historiqueContent');
  container.innerHTML = '';

  if (!historique || historique.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun historique disponible</p>';
    return;
  }

  historique.forEach(h => {
    const div = document.createElement('div');
    div.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition';
    div.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <p class="font-semibold text-gray-800">
            ${API_CONFIG.agencesMap[h.agence] || h.agence} - ${h.version}
          </p>
          <p class="text-sm text-gray-600">
            ${h.utilisateur} (${h.email})
          </p>
          <p class="text-sm text-gray-500">
            ${h.nbClients} clients import√©s
          </p>
        </div>
        <div class="text-right">
          <p class="text-sm font-medium text-blue-600">${h.date}</p>
          <p class="text-xs text-gray-500">${h.heure}</p>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

// ============================================
// CONFIGURATION
// ============================================
function sauvegarderConfig() {
  const url = document.getElementById('apiUrlInput').value.trim();
  
  if (!url) {
    showMessage('configMessage', 'Veuillez entrer une URL', 'error');
    return;
  }

  API_CONFIG.workerUrl = url;
  localStorage.setItem('apiUrl', url);
  showMessage('configMessage', '‚úÖ Configuration sauvegard√©e', 'success');
  console.log('üíæ URL sauvegard√©e:', url);
}

async function testerConnexion() {
  const url = document.getElementById('apiUrlInput').value.trim() || API_CONFIG.workerUrl;
  
  showMessage('configMessage', 'üîÑ Test en cours...', 'info');

  try {
    console.log('üß™ Test connexion:', url);
    
    const response = await fetch(`${url}?action=test`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    console.log('üì• Status:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ R√©ponse:', data);

    if (data.status === 'success' || data.success) {
      showMessage('configMessage', '‚úÖ Connexion r√©ussie ! API op√©rationnelle', 'success');
      showSuccess('API connect√©e avec succ√®s');
    } else {
      showMessage('configMessage', '‚ö†Ô∏è Connexion √©tablie mais r√©ponse inattendue', 'warning');
    }
  } catch (error) {
    console.error('‚ùå Erreur test:', error);
    showMessage('configMessage', '‚ùå Erreur de connexion : ' + error.message, 'error');
  }
}

// ============================================
// HELPERS UI
// ============================================
function showLoading(message) {
  let loadingDiv = document.getElementById('globalLoading');
  
  if (!loadingDiv) {
    loadingDiv = document.createElement('div');
    loadingDiv.id = 'globalLoading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    
    loadingDiv.innerHTML = `
      <div style="background: white; padding: 30px 50px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); text-align: center;">
        <div class="spinner" style="margin: 0 auto 15px;"></div>
        <p id="loadingText" style="font-weight: 600; color: #1e40af; margin: 0;"></p>
      </div>
    `;
    
    document.body.appendChild(loadingDiv);
  }
  
  document.getElementById('loadingText').textContent = message;
  loadingDiv.style.display = 'flex';
}

function hideLoading() {
  const loadingDiv = document.getElementById('globalLoading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
}

function showSuccess(message) {
  showNotification(message, 'success');
}

function showError(message) {
  showNotification(message, 'error');
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  const bgColor = type === 'success' ? '#10b981' : 
                  type === 'error' ? '#ef4444' : 
                  type === 'warning' ? '#f59e0b' : '#3b82f6';
  
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    background: ${bgColor};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10001;
    max-width: 400px;
    font-weight: 500;
  `;
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('slide-out');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// ============================================
// UTILITAIRES
// ============================================
function formatMontant(montant) {
  if (!montant || isNaN(montant)) return '0,00 ‚Ç¨';
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  }).format(montant);
}

function showMessage(elementId, message, type) {
  const el = document.getElementById(elementId);
  el.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'bg-yellow-100');
  el.classList.remove('border-red-400', 'border-green-400', 'border-blue-400', 'border-yellow-400');
  el.classList.remove('text-red-700', 'text-green-700', 'text-blue-700', 'text-yellow-700');

  if (type === 'error') {
    el.className = 'p-4 rounded-lg border bg-red-100 border-red-400 text-red-700';
  } else if (type === 'success') {
    el.className = 'p-4 rounded-lg border bg-green-100 border-green-400 text-green-700';
  } else if (type === 'warning') {
    el.className = 'p-4 rounded-lg border bg-yellow-100 border-yellow-400 text-yellow-700';
  } else {
    el.className = 'p-4 rounded-lg border bg-blue-100 border-blue-400 text-blue-700';
  }

  el.textContent = message;
  el.classList.add('fade-in');
}

// ============================================
// LOGS DE DEBUG
// ============================================
console.log('‚úÖ Script charg√© avec succ√®s');
console.log('üì° Configuration API:', API_CONFIG);
  </script>
</body>
</html>
          
