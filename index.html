<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olympic Location - Balance √Çg√©e (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .comment-input-cell {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 40px;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .comment-input-cell:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .comment-input-cell.has-comment {
            background-color: #fef3c7;
            border-color: #f59e0b;
            font-weight: 500;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            display: none;
            z-index: 2000;
            animation: fadeInOut 2s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            background: #e5e7eb;
        }
        .tab-button.active {
            background: white;
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .version-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .version-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="save-indicator" id="saveIndicator">‚úì Sauvegarde effectu√©e</div>

    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üè¢ Olympic Location</h1>
                    <p class="text-blue-100 text-sm">Balance √Çg√©e - Version Cloud</p>
                </div>
                <div class="text-right">
                    <p class="text-sm">Utilisateur: <span id="userName">-</span></p>
                    <p class="text-xs text-blue-100">Agence: <span id="currentAgence">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex space-x-2">
                <button class="tab-button active" onclick="switchTab('import')">üì§ Import</button>
                <button class="tab-button" onclick="switchTab('analyse')">üìä Analyse</button>
                <button class="tab-button" onclick="switchTab('versions')">üìã Versions</button>
                <button class="tab-button" onclick="switchTab('historique')">üïê Historique</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- TAB: Import -->
        <div id="tab-import" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configuration</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                        <input type="text" id="configUserName" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2" placeholder="Votre nom" value="Julien">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="configEmail" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2" placeholder="email@olympiclocation.com" value="julien@olympiclocation.com">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
                    <select id="configAgence" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2">
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="09" selected>09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                        <option value="08">08 - Toulon</option>
                    </select>
                </div>

                <button onclick="saveConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">
                    üíæ Enregistrer la configuration
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">üì§ Charger votre fichier Excel</h2>
                
                <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 mb-2">Glissez-d√©posez votre fichier Excel ici</p>
                    <p class="text-sm text-gray-500">ou</p>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv">
                    <button onclick="document.getElementById('fileInput').click()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Parcourir
                    </button>
                </div>

                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">üí° Colonnes requises dans votre fichier :</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ <strong>Code Client</strong> (obligatoire)</li>
                        <li>‚Ä¢ <strong>Nom Client</strong> (obligatoire)</li>
                        <li>‚Ä¢ <strong>Solde</strong> (obligatoire)</li>
                        <li>‚Ä¢ <strong>√âch√©ances :</strong> 0-30j, 30-60j, 60-90j, >90j</li>
                        <li>‚Ä¢ Les donn√©es seront automatiquement sauvegard√©es dans Google Sheets</li>
                    </ul>
                </div>

                <div class="mt-4 flex space-x-3">
                    <button onclick="analyzeAndSaveToCloud()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center">
                        <span class="mr-2">‚òÅÔ∏è</span> Analyser et Sauvegarder dans le Cloud
                    </button>
                    <button onclick="analyzeLocalOnly()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-semibold">
                        üìä Analyser localement uniquement
                    </button>
                </div>
            </div>

            <div id="loadingIndicator" class="loading bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center">
                    <div class="animate-pulse mr-4">
                        <div class="h-4 w-4 bg-blue-500 rounded-full"></div>
                    </div>
                    <p class="text-gray-600">Analyse en cours...</p>
                </div>
            </div>
        </div>

        <!-- TAB: Analyse -->
        <div id="tab-analyse" class="tab-content">
            <div id="analysisResults" class="hidden">
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border-2 border-purple-200">
                    <h2 class="text-xl font-semibold mb-4 text-purple-800">üíº Calcul du Taux d'Impay√©s</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Chiffre d'Affaires Annuel (‚Ç¨)</label>
                            <input type="number" id="chiffreAffaires" class="w-full border-2 border-purple-300 rounded-lg px-4 py-2" placeholder="Ex: 1000000" min="0">
                        </div>
                        <div>
                            <button onclick="calculateTauxImpaye()" class="w-full bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-semibold">
                                Calculer
                            </button>
                        </div>
                        <div id="tauxImpayeResult" class="hidden bg-white rounded-lg p-4 border-2 border-purple-300">
                            <p class="text-sm text-gray-600">Taux d'Impay√©s</p>
                            <p id="tauxImpayeValue" class="text-2xl font-bold"></p>
                            <p id="tauxImpayeStatus" class="text-xs mt-1"></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4">üìä Synth√®se Globale</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="bg-red-50 rounded-lg p-4">
                            <p class="text-sm text-red-600">Soldes D√©biteurs</p>
                            <p id="soldesDebiteurs" class="text-2xl font-bold text-red-800">-</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-sm text-green-600">Soldes Cr√©diteurs</p>
                            <p id="soldesCrediteurs" class="text-2xl font-bold text-green-800">-</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-blue-600">Balance Totale</p>
                            <p id="balanceTotale" class="text-2xl font-bold text-blue-800">-</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4">
                            <p class="text-sm text-orange-600">Clients > 90j</p>
                            <p id="clientsCritiques" class="text-2xl font-bold text-orange-800">-</p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <p class="text-sm text-yellow-600">Taux de risque</p>
                            <p id="tauxRisque" class="text-2xl font-bold text-yellow-800">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìã D√©tail par Client</h2>
                        <div class="space-x-2">
                            <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                üì• Export Excel
                            </button>
                            <button onclick="window.print()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                                üñ®Ô∏è Imprimer
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="clientsTable" class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left">Code</th>
                                    <th class="px-4 py-3 text-left">Nom Client</th>
                                    <th class="px-4 py-3 text-right">Solde</th>
                                    <th class="px-4 py-3 text-right">0-30j</th>
                                    <th class="px-4 py-3 text-right">30-60j</th>
                                    <th class="px-4 py-3 text-right">60-90j</th>
                                    <th class="px-4 py-3 text-right">> 90j</th>
                                    <th class="px-4 py-3 text-center">Risque</th>
                                    <th class="px-4 py-3 text-center">Commentaires</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">üìä R√©partition par anciennet√©</h3>
                        <canvas id="ageChart"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">üéØ Top 10 clients √† risque</h3>
                        <canvas id="topClientsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Versions -->
        <div id="tab-versions" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üìã Versions sauvegard√©es</h2>
                    <button onclick="loadVersionsList()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        üîÑ Actualiser
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrer par agence</label>
                    <select id="filterAgence" onchange="loadVersionsList()" class="w-full md:w-64 border-2 border-gray-300 rounded-lg px-4 py-2">
                        <option value="">Toutes les agences</option>
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="09">09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                        <option value="08">08 - Toulon</option>
                    </select>
                </div>

                <div id="versionsList"></div>
            </div>
        </div>

        <!-- TAB: Historique -->
        <div id="tab-historique" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üïê Historique des imports</h2>
                    <button onclick="loadHistorique()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        üîÑ Actualiser
                    </button>
                </div>
                <div id="historiqueList"></div>
            </div>
        </div>
    </div>

    <!-- Modal Commentaires -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üí¨ Commentaires Client</h3>
            <div class="bg-blue-50 p-3 rounded mb-4">
                <p class="text-sm"><strong>Code:</strong> <span id="modalClientCode"></span></p>
                <p class="text-sm"><strong>Nom:</strong> <span id="modalClientName"></span></p>
                <p class="text-sm"><strong>Solde:</strong> <span id="modalClientSolde"></span></p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Historique :</label>
                <div id="commentHistory" class="max-h-48 overflow-y-auto bg-gray-50 p-3 rounded"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau commentaire :</label>
                <textarea id="newCommentText" class="w-full border rounded px-3 py-2" rows="3"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeCommentModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Annuler
                </button>
                <button onclick="saveNewComment()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzBWezbMQZwNYfV4PJm1-TdVKQwKFWUsUxHxd2N_-1rFH7w1ewe57hyaZHxnvTiXFiD/exec';
        
        let currentData = [];
        let currentClientForComment = null;
        let clientComments = {};
        let ageChartInstance = null;
        let topClientsChartInstance = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupFileUpload();
            setupDropZone();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'versions') loadVersionsList();
            else if (tabName === 'historique') loadHistorique();
        }

        function saveConfig() {
            const config = {
                userName: document.getElementById('configUserName').value,
                email: document.getElementById('configEmail').value,
                agence: document.getElementById('configAgence').value
            };
            localStorage.setItem('olConfig', JSON.stringify(config));
            document.getElementById('userName').textContent = config.userName;
            document.getElementById('currentAgence').textContent = config.agence;
            showSaveIndicator();
            alert('‚úÖ Configuration enregistr√©e !');
        }

        function loadConfig() {
            const saved = localStorage.getItem('olConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('configUserName').value = config.userName || '';
                document.getElementById('configEmail').value = config.email || '';
                document.getElementById('configAgence').value = config.agence || '09';
                document.getElementById('userName').textContent = config.userName || '-';
                document.getElementById('currentAgence').textContent = config.agence || '-';
            }
        }

        function getConfig() {
            const saved = localStorage.getItem('olConfig');
            return saved ? JSON.parse(saved) : {
                userName: 'Utilisateur',
                email: 'user@olympiclocation.com',
                agence: '09'
            };
        }

        function setupFileUpload() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        }

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    console.log('Donn√©es brutes Excel:', jsonData);
                    
                    currentData = parseExcelData(jsonData);
                    console.log('Donn√©es pars√©es:', currentData);
                    
                    if (currentData.length === 0) {
                        alert('‚ùå Aucune donn√©e d√©tect√©e. V√©rifiez les colonnes de votre fichier.');
                    } else {
                        alert(`‚úÖ Fichier charg√© : ${currentData.length} clients d√©tect√©s`);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier : ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelData(jsonData) {
            return jsonData.map(row => {
                // Recherche flexible des colonnes
                const keys = Object.keys(row);
                
                const codeKey = keys.find(k => k.toLowerCase().includes('code'));
                const nomKey = keys.find(k => k.toLowerCase().includes('nom') || k.toLowerCase().includes('client'));
                const soldeKey = keys.find(k => k.toLowerCase().includes('solde'));
                const e0Key = keys.find(k => k.includes('0-30') || k.includes('0 30'));
                const e30Key = keys.find(k => k.includes('30-60') || k.includes('30 60'));
                const e60Key = keys.find(k => k.includes('60-90') || k.includes('60 90'));
                const e90Key = keys.find(k => k.includes('>90') || k.includes('90') || k.includes('plus 90'));
                
                const codeClient = row[codeKey] || '';
                const nomClient = row[nomKey] || '';
                const solde = parseFloat(row[soldeKey] || 0);
                const echeance0 = parseFloat(row[e0Key] || 0);
                const echeance30 = parseFloat(row[e30Key] || 0);
                                  const echeance60 = parseFloat(row[e60Key] || 0);
                  const echeance90 = parseFloat(row[e90Key] || 0);
                  
                  return {
                      codeClient: String(codeClient).trim(),
                      nomClient: String(nomClient).trim(),
                      solde: solde,
                      echeance0: echeance0,
                      echeance30: echeance30,
                      echeance60: echeance60,
                      echeance90: echeance90,
                      echeancePlus120: 0
                  };
              }).filter(client => client.codeClient && client.nomClient);
          }

          async function analyzeAndSaveToCloud() {
              if (currentData.length === 0) {
                  alert('‚ùå Veuillez d\'abord charger un fichier Excel');
                  return;
              }

              const config = getConfig();
              if (!config.userName || !config.email || !config.agence) {
                  alert('‚ùå Veuillez d\'abord configurer vos informations (nom, email, agence)');
                  switchTab('import');
                  return;
              }

              document.getElementById('loadingIndicator').classList.add('active');

              try {
                  const dataEncoded = encodeURIComponent(JSON.stringify(currentData));
                  const url = `${API_URL}?action=importerBalance&data=${dataEncoded}&agence=${config.agence}&email=${encodeURIComponent(config.email)}&nom=${encodeURIComponent(config.userName)}`;
                  
                  console.log('Envoi vers API...');
                  const response = await fetch(url, {
                      method: 'GET',
                      mode: 'cors'
                  });
                  
                  const result = await response.json();
                  console.log('R√©ponse API:', result);
                  
                  document.getElementById('loadingIndicator').classList.remove('active');
                  
                  if (result.success) {
                      alert(`‚úÖ ${result.message}\n\nVersion: ${result.version}\nDate: ${result.dateImport} √† ${result.heureImport}\nClients: ${result.nbClients}`);
                      
                      displayAnalysis();
                      switchTab('analyse');
                  } else {
                      alert('‚ùå Erreur : ' + result.message);
                  }
              } catch (error) {
                  document.getElementById('loadingIndicator').classList.remove('active');
                  console.error('Erreur compl√®te:', error);
                  alert('‚ùå Erreur lors de la sauvegarde : ' + error.message + '\n\nV√©rifiez que l\'API Google Apps Script est bien d√©ploy√©e et accessible.');
              }
          }

          function analyzeLocalOnly() {
              if (currentData.length === 0) {
                  alert('‚ùå Veuillez d\'abord charger un fichier Excel');
                  return;
              }
              
              displayAnalysis();
              switchTab('analyse');
          }

          function displayAnalysis() {
              document.getElementById('analysisResults').classList.remove('hidden');
              
              let soldesDebiteurs = 0;
              let soldesCrediteurs = 0;
              let clientsCritiques = 0;
              let total0_30 = 0;
              let total30_60 = 0;
              let total60_90 = 0;
              let total90plus = 0;

              currentData.forEach(client => {
                  if (client.solde > 0) {
                      soldesDebiteurs += client.solde;
                  } else {
                      soldesCrediteurs += Math.abs(client.solde);
                  }
                  
                  if (client.echeance90 > 0 || client.echeancePlus120 > 0) {
                      clientsCritiques++;
                  }
                  
                  total0_30 += client.echeance0 || 0;
                  total30_60 += client.echeance30 || 0;
                  total60_90 += client.echeance60 || 0;
                  total90plus += (client.echeance90 || 0) + (client.echeancePlus120 || 0);
              });

              const balanceTotale = soldesDebiteurs - soldesCrediteurs;
              const tauxRisque = soldesDebiteurs > 0 ? ((total90plus / soldesDebiteurs) * 100).toFixed(1) : 0;

              document.getElementById('soldesDebiteurs').textContent = formatCurrency(soldesDebiteurs);
              document.getElementById('soldesCrediteurs').textContent = formatCurrency(soldesCrediteurs);
              document.getElementById('balanceTotale').textContent = formatCurrency(balanceTotale);
              document.getElementById('clientsCritiques').textContent = clientsCritiques;
              document.getElementById('tauxRisque').textContent = tauxRisque + '%';

              displayTable();
              displayCharts(total0_30, total30_60, total60_90, total90plus);
          }

          function displayTable() {
              const tbody = document.getElementById('clientsTableBody');
              tbody.innerHTML = '';

              currentData.forEach((client, index) => {
                  const risque = calculateRisk(client);
                  const risqueBadge = getRiskBadge(risque);
                  
                  const row = document.createElement('tr');
                  row.className = 'hover:bg-gray-50';
                  row.innerHTML = `
                      <td class="px-4 py-3">${client.codeClient}</td>
                      <td class="px-4 py-3">${client.nomClient}</td>
                      <td class="px-4 py-3 text-right font-semibold ${client.solde >= 0 ? 'text-red-600' : 'text-green-600'}">
                          ${formatCurrency(client.solde)}
                      </td>
                      <td class="px-4 py-3 text-right">${formatCurrency(client.echeance0 || 0)}</td>
                      <td class="px-4 py-3 text-right">${formatCurrency(client.echeance30 || 0)}</td>
                      <td class="px-4 py-3 text-right">${formatCurrency(client.echeance60 || 0)}</td>
                      <td class="px-4 py-3 text-right">${formatCurrency(client.echeance90 || 0)}</td>
                      <td class="px-4 py-3 text-center">${risqueBadge}</td>
                      <td class="px-4 py-3 text-center">
                          <button onclick="openCommentModal(${index})" class="comment-input-cell ${clientComments[client.codeClient] ? 'has-comment' : ''}">
                              ${clientComments[client.codeClient] ? 'üí¨ ' + clientComments[client.codeClient].length : '‚ûï'}
                          </button>
                      </td>
                  `;
                  tbody.appendChild(row);
              });
          }

          function calculateRisk(client) {
              const solde = Math.abs(client.solde);
              const plus90 = (client.echeance90 || 0) + (client.echeancePlus120 || 0);
              
              if (plus90 > solde * 0.5) return '√âLEV√â';
              if (plus90 > solde * 0.3) return 'MOYEN';
              if (plus90 > 0) return 'FAIBLE';
              return 'OK';
          }

          function getRiskBadge(risk) {
              const badges = {
                  '√âLEV√â': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold">üî¥ √âLEV√â</span>',
                  'MOYEN': '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-bold">üü† MOYEN</span>',
                  'FAIBLE': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-bold">üü° FAIBLE</span>',
                  'OK': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">üü¢ OK</span>'
              };
              return badges[risk] || badges['OK'];
          }

          function displayCharts(total0_30, total30_60, total60_90, total90plus) {
              const ageCtx = document.getElementById('ageChart').getContext('2d');
              if (ageChartInstance) ageChartInstance.destroy();
              
              ageChartInstance = new Chart(ageCtx, {
                  type: 'doughnut',
                  data: {
                      labels: ['0-30j', '30-60j', '60-90j', '>90j'],
                      datasets: [{
                          data: [total0_30, total30_60, total60_90, total90plus],
                          backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#7c3aed']
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { position: 'bottom' }
                      }
                  }
              });

              const topClients = [...currentData]
                  .sort((a, b) => Math.abs(b.solde) - Math.abs(a.solde))
                  .slice(0, 10);

              const topCtx = document.getElementById('topClientsChart').getContext('2d');
              if (topClientsChartInstance) topClientsChartInstance.destroy();
              
              topClientsChartInstance = new Chart(topCtx, {
                  type: 'bar',
                  data: {
                      labels: topClients.map(c => c.nomClient.substring(0, 15)),
                      datasets: [{
                          label: 'Solde (‚Ç¨)',
                          data: topClients.map(c => Math.abs(c.solde)),
                          backgroundColor: '#3b82f6'
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { display: false }
                      },
                      scales: {
                          y: { beginAtZero: true }
                      }
                  }
              });
          }

          function calculateTauxImpaye() {
              const ca = parseFloat(document.getElementById('chiffreAffaires').value);
              if (!ca || ca <= 0) {
                  alert('‚ùå Veuillez saisir un chiffre d\'affaires valide');
                  return;
              }

              const soldesDebiteurs = currentData.reduce((sum, c) => sum + (c.solde > 0 ? c.solde : 0), 0);
              const taux = (soldesDebiteurs / ca) * 100;

              document.getElementById('tauxImpayeResult').classList.remove('hidden');
              document.getElementById('tauxImpayeValue').textContent = taux.toFixed(2) + '%';
              
              const statusEl = document.getElementById('tauxImpayeStatus');
              if (taux < 2) {
                  statusEl.textContent = '‚úÖ Excellent';
                  statusEl.className = 'text-xs mt-1 text-green-600 font-semibold';
              } else if (taux < 5) {
                  statusEl.textContent = '‚ö†Ô∏è Attention';
                  statusEl.className = 'text-xs mt-1 text-orange-600 font-semibold';
              } else {
                  statusEl.textContent = 'üî¥ Critique';
                  statusEl.className = 'text-xs mt-1 text-red-600 font-semibold';
              }
          }

          function openCommentModal(index) {
              currentClientForComment = currentData[index];
              
              document.getElementById('modalClientCode').textContent = currentClientForComment.codeClient;
              document.getElementById('modalClientName').textContent = currentClientForComment.nomClient;
              document.getElementById('modalClientSolde').textContent = formatCurrency(currentClientForComment.solde);
              
              const comments = clientComments[currentClientForComment.codeClient] || [];
              const historyDiv = document.getElementById('commentHistory');
              
              if (comments.length === 0) {
                  historyDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun commentaire</p>';
              } else {
                  historyDiv.innerHTML = comments.map(c => `
                      <div class="bg-gray-100 p-3 rounded mb-2">
                          <div class="text-xs text-gray-600">${c.date} - ${c.author}</div>
                          <div class="text-sm mt-1">${c.text}</div>
                      </div>
                  `).join('');
              }
              
              document.getElementById('newCommentText').value = '';
              document.getElementById('commentModal').classList.add('active');
          }

          function closeCommentModal() {
              document.getElementById('commentModal').classList.remove('active');
              currentClientForComment = null;
          }

          function saveNewComment() {
              const text = document.getElementById('newCommentText').value.trim();
              if (!text) {
                  alert('‚ùå Veuillez saisir un commentaire');
                  return;
              }

              const config = getConfig();
              const comment = {
                  date: new Date().toLocaleString('fr-FR'),
                  author: config.userName,
                  text: text
              };

              if (!clientComments[currentClientForComment.codeClient]) {
                  clientComments[currentClientForComment.codeClient] = [];
              }
              clientComments[currentClientForComment.codeClient].push(comment);
              
              localStorage.setItem('olComments', JSON.stringify(clientComments));
              
              closeCommentModal();
              displayTable();
              showSaveIndicator();
          }

          async function loadVersionsList() {
              const agence = document.getElementById('filterAgence').value;
              const container = document.getElementById('versionsList');
              
              container.innerHTML = '<div class="text-center py-8"><div class="animate-pulse">Chargement...</div></div>';

              try {
                  const url = agence ? `${API_URL}?action=listerVersions&agence=${agence}` : `${API_URL}?action=listerVersions`;
                  const response = await fetch(url);
                  const result = await response.json();

                  if (result.success && result.versions.length > 0) {
                      container.innerHTML = result.versions.map(v => `
                          <div class="version-card" onclick="loadVersion('${v.agence}', '${v.version}')">
                              <div class="flex justify-between items-center">
                                  <div>
                                      <div class="font-bold text-lg">${v.version}</div>
                                      <div class="text-sm text-gray-600">Agence ${v.agence} - ${v.nbClients} clients</div>
                                      <div class="text-xs text-gray-500 mt-1">üìÖ ${v.date} √† ${v.heure} | üë§ ${v.utilisateur}</div>
                                  </div>
                                  <div class="text-blue-600 text-2xl">üëÅÔ∏è</div>
                              </div>
                          </div>
                      `).join('');
                  } else {
                      container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucune version disponible</div>';
                  }
              } catch (error) {
                  container.innerHTML = '<div class="text-center py-8 text-red-600">‚ùå Erreur de chargement</div>';
              }
          }

          async function loadVersion(agence, version) {
              if (!confirm(`Charger la version ${version} de l'agence ${agence} ?`)) return;

              try {
                  const response = await fetch(`${API_URL}?action=chargerVersion&agence=${agence}&version=${version}`);
                  const result = await response.json();

                  if (result.success) {
                      currentData = result.donnees;
                      displayAnalysis();
                      switchTab('analyse');
                      alert(`‚úÖ Version ${version} charg√©e avec succ√®s !`);
                  } else {
                      alert('‚ùå Erreur : ' + result.message);
                  }
              } catch (error) {
                  alert('‚ùå Erreur de chargement : ' + error.message);
              }
          }

          async function loadHistorique() {
              const container = document.getElementById('historiqueList');
              container.innerHTML = '<div class="text-center py-8"><div class="animate-pulse">Chargement...</div></div>';

              try {
                  const response = await fetch(`${API_URL}?action=listerHistorique`);
                  const result = await response.json();

                  if (result.success && result.historique.length > 0) {
                      container.innerHTML = `
                          <div class="overflow-x-auto">
                              <table class="w-full text-sm">
                                  <thead class="bg-gray-100">
                                      <tr>
                                          <th class="px-4 py-3 text-left">Date</th>
                                          <th class="px-4 py-3 text-left">Heure</th>
                                          <th class="px-4 py-3 text-left">Agence</th>
                                          <th class="px-4 py-3 text-left">Version</th>
                                          <th class="px-4 py-3 text-left">Utilisateur</th>
                                          <th class="px-4 py-3 text-right">Clients</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      ${result.historique.map(h => `
                                          <tr class="border-b hover:bg-gray-50">
                                              <td class="px-4 py-3">${h.date}</td>
                                              <td class="px-4 py-3">${h.heure}</td>
                                              <td class="px-4 py-3">${h.agence}</td>
                                              <td class="px-4 py-3 font-semibold">${h.version}</td>
                                              <td class="px-4 py-3">${h.utilisateur}</td>
                                              <td class="px-4 py-3 text-right">${h.nbClients}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                      `;
                  } else {
                      container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucun historique disponible</div>';
                  }
              } catch (error) {
                  container.innerHTML = '<div class="text-center py-8 text-red-600">‚ùå Erreur de chargement</div>';
              }
          }

          function exportToExcel() {
              const ws = XLSX.utils.json_to_sheet(currentData);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, "Balance");
              
              const config = getConfig();
              const filename = `Balance_Agee_${config.agence}_${new Date().toISOString().split('T')[0]}.xlsx`;
              XLSX.writeFile(wb, filename);
          }

          function formatCurrency(value) {
              return new Intl.NumberFormat('fr-FR', {
                  style: 'currency',
                  currency: 'EUR'
              }).format(value);
          }

          function showSaveIndicator() {
              const indicator = document.getElementById('saveIndicator');
              indicator.style.display = 'block';
              setTimeout(() => {
                  indicator.style.display = 'none';
              }, 2000);
          }

          const savedComments = localStorage.getItem('olComments');
          if (savedComments) {
              clientComments = JSON.parse(savedComments);
          }
      </script>
  </body>
  </html>
