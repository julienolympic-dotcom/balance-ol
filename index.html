<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance √Çg√©e - Olympic Location</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: flex;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            display: none;
            z-index: 2000;
        }
        .tab-button {
            padding: 12px 24px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .version-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .version-card:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Indicateur de sauvegarde -->
    <div class="save-indicator" id="saveIndicator">‚úì Sauvegarde effectu√©e</div>
    
    <!-- Indicateur de chargement -->
    <div id="loadingIndicator" class="loading fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-pulse text-4xl mb-4">‚è≥</div>
            <p class="text-lg font-semibold">Chargement en cours...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- En-t√™te -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üè¶ Analyseur de Balances √Çg√©es</h1>
            <p class="text-gray-600">Olympic Location - Version Cloud</p>
            <div id="userInfo" class="mt-2 text-sm text-gray-500"></div>
        </div>

        <!-- Navigation par onglets -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="flex border-b overflow-x-auto">
                <button class="tab-button active" data-tab="config">‚öôÔ∏è Configuration</button>
                <button class="tab-button" data-tab="import">üì§ Import</button>
                <button class="tab-button" data-tab="analyse">üìä Analyse</button>
                <button class="tab-button" data-tab="versions">üìÅ Versions</button>
                <button class="tab-button" data-tab="historique">üìú Historique</button>
            </div>

            <!-- Onglet Configuration -->
            <div id="tab-config" class="tab-content active p-6">
                <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>‚ö†Ô∏è Important :</strong> Configurez l'URL de votre Google Apps Script ci-dessous
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script :</label>
                        <input type="text" id="apiUrl" class="w-full border rounded px-3 py-2" placeholder="https://script.google.com/macros/s/...">
                        <p class="text-xs text-gray-500 mt-1">L'URL de d√©ploiement de votre script Apps Script</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Votre email :</label>
                        <input type="email" id="userEmail" class="w-full border rounded px-3 py-2" placeholder="prenom@olympiclocation.com">
                    </div>
                    
                    <button onclick="testConnection()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        üîå Tester la connexion
                    </button>
                    
                    <div id="connectionStatus" class="hidden mt-4"></div>
                </div>
            </div>

            <!-- Onglet Import -->
            <div id="tab-import" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">üì§ Importer une balance</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">S√©lectionner l'agence :</label>
                    <select id="agenceSelect" class="w-full border rounded px-3 py-2">
                        <option value="">-- Choisir une agence --</option>
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="09">09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                        <option value="08">08 - Toulon</option>
                    </select>
                </div>
                
                <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 mb-2">Glissez-d√©posez votre fichier Excel ici</p>
                    <p class="text-sm text-gray-500">ou</p>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv">
                    <button onclick="document.getElementById('fileInput').click()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Parcourir
                    </button>
                </div>

                <div id="fileInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-green-800">‚úÖ <span id="fileName"></span></p>
                    <p class="text-sm text-green-600">Lignes d√©tect√©es : <span id="rowCount"></span></p>
                </div>

                <button onclick="importerBalance()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                    üíæ Importer dans le Cloud
                </button>

                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">üí° Format attendu :</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ <strong>Code Client</strong> : Identifiant unique</li>
                        <li>‚Ä¢ <strong>Nom Client</strong> : Raison sociale</li>
                        <li>‚Ä¢ <strong>Solde</strong> : Solde total</li>
                        <li>‚Ä¢ <strong>√âch√©ances</strong> : 0-30j, 30-60j, 60-90j, 90-120j, >120j</li>
                        <li>‚Ä¢ <strong>Paiement</strong> : Montant des paiements</li>
                    </ul>
                </div>
            </div>

            <!-- Onglet Analyse -->
            <div id="tab-analyse" class="tab-content p-6">
                <div class="mb-4 flex space-x-4">
                    <select id="analyseAgence" class="flex-1 border rounded px-3 py-2">
                        <option value="">-- Choisir une agence --</option>
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="09">09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                        <option value="08">08 - Toulon</option>
                    </select>
                    <select id="analyseVersion" class="flex-1 border rounded px-3 py-2">
                        <option value="latest">Derni√®re version</option>
                    </select>
                    <button onclick="chargerEtAnalyser()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        üìä Charger
                    </button>
                </div>
                
                <div id="analysisResults" class="hidden">
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-600 mb-1">Soldes D√©biteurs</p>
                            <p class="text-2xl font-bold text-red-700" id="soldesDebiteurs">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-600 mb-1">Soldes Cr√©diteurs</p>
                            <p class="text-2xl font-bold text-green-700" id="soldesCrediteurs">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-600 mb-1">Balance Totale</p>
                            <p class="text-2xl font-bold text-blue-700" id="balanceTotale">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <p class="text-sm text-orange-600 mb-1">Clients √† Risque</p>
                            <p class="text-2xl font-bold text-orange-700" id="clientsCritiques">0</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <p class="text-sm text-purple-600 mb-1">Taux >90j</p>
                            <p class="text-2xl font-bold text-purple-700" id="tauxRisque">0%</p>
                        </div>
                    </div>

                    <!-- Graphiques -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">R√©partition par anciennet√©</h3>
                            <canvas id="ageChart"></canvas>
                        </div>
                        <div class="bg-white border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">Top 10 clients</h3>
                            <canvas id="topClientsChart"></canvas>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="bg-white border rounded-lg overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b">
                            <h3 class="font-semibold">Liste des clients</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Code</th>
                                        <th class="px-4 py-3 text-left">Nom</th>
                                        <th class="px-4 py-3 text-right">Solde</th>
                                        <th class="px-4 py-3 text-right">0-30j</th>
                                        <th class="px-4 py-3 text-right">30-60j</th>
                                        <th class="px-4 py-3 text-right">60-90j</th>
                                        <th class="px-4 py-3 text-right">90-120j</th>
                                        <th class="px-4 py-3 text-right">>120j</th>
                                        <th class="px-4 py-3 text-right">Paiement</th>
                                        <th class="px-4 py-3 text-center">Risque</th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export -->
                    <div class="mt-6 flex space-x-4">
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                            üì• Exporter en Excel
                        </button>
                        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                            üñ®Ô∏è Imprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Onglet Versions -->
            <div id="tab-versions" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">üìÅ Versions sauvegard√©es</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Agence :</label>
                    <select id="versionsAgence" onchange="chargerVersions()" class="w-full border rounded px-3 py-2">
                        <option value="">-- Choisir une agence --</option>
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="09">09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                        <option value="08">08 - Toulon</option>
                    </select>
                </div>
                
                <div id="versionsList"></div>
            </div>

            <!-- Onglet Historique -->
            <div id="tab-historique" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">üìú Historique des imports</h2>
                <button onclick="chargerHistorique()" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    üîÑ Actualiser
                </button>
                <div id="historiqueList"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let currentData = [];
        let analysisData = [];
        let ageChartInstance = null;
        let topClientsChartInstance = null;
        let API_URL = '';
        let USER_EMAIL = '';
        let USER_NAME = '';

        // ========== INITIALISATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Application d√©marr√©e');
            loadConfig();
            setupFileHandlers();
            setupTabHandlers();
            
            // Masquer le chargement initial
            hideLoading();
        });

        // ========== GESTION DU LOADING ==========
        function showLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.classList.add('active');
            }
        }

        function hideLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.classList.remove('active');
            }
        }

        // ========== CONFIGURATION ==========
        function loadConfig() {
            try {
                const config = localStorage.getItem('olBalanceConfig');
                if (config) {
                    const data = JSON.parse(config);
                    document.getElementById('apiUrl').value = data.apiUrl || '';
                    document.getElementById('userEmail').value = data.email || '';
                    API_URL = data.apiUrl || '';
                    USER_EMAIL = data.email || '';
                    USER_NAME = data.name || '';
                    
                    if (USER_EMAIL) {
                        document.getElementById('userInfo').textContent = `Connect√© en tant que : ${USER_EMAIL}`;
                    }
                }
            } catch (error) {
                console.error('Erreur loadConfig:', error);
            }
        }

        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            if (!apiUrl) {
                alert('‚ùå Veuillez saisir l\'URL de votre Google Apps Script');
                return;
            }
            
            if (!email) {
                alert('‚ùå Veuillez saisir votre email');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${apiUrl}?action=test`, {
                    method: 'GET',
                    mode: 'cors'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    const config = {
                        apiUrl: apiUrl,
                        email: email,
                        name: email.split('@')[0]
                    };
                    localStorage.setItem('olBalanceConfig', JSON.stringify(config));
                    API_URL = apiUrl;
                    USER_EMAIL = email;
                    USER_NAME = config.name;
                    
                    document.getElementById('connectionStatus').className = 'bg-green-50 border border-green-200 rounded-lg p-4';
                    document.getElementById('connectionStatus').innerHTML = `
                        <p class="text-green-800 font-semibold">‚úÖ Connexion r√©ussie !</p>
                        <p class="text-sm text-green-600 mt-1">${result.message}</p>
                    `;
                    document.getElementById('connectionStatus').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `Connect√© en tant que : ${email}`;
                    
                    showSaveIndicator();
                } else {
                    throw new Error(result.message || 'R√©ponse invalide du serveur');
                }
            } catch (error) {
                console.error('Erreur testConnection:', error);
                document.getElementById('connectionStatus').className = 'bg-red-50 border border-red-200 rounded-lg p-4';
                document.getElementById('connectionStatus').innerHTML = `
                    <p class="text-red-800 font-semibold">‚ùå Erreur de connexion</p>
                    <p class="text-sm text-red-600 mt-1">${error.message}</p>
                `;
                document.getElementById('connectionStatus').classList.remove('hidden');
            } finally {
                hideLoading();
            }
        }

        // ========== GESTION DES ONGLETS ==========
        function setupTabHandlers() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            try {
                // Retirer la classe active
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Activer le bouton
                const activeButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
                
                // Activer le contenu
                const tabContent = document.getElementById('tab-' + tabName);
                if (tabContent) {
                    tabContent.classList.add('active');
                    
                    // Actions sp√©cifiques
                    if (tabName === 'versions') {
                        const agence = document.getElementById('versionsAgence').value;
                        if (agence) {
                            setTimeout(() => chargerVersions(), 100);
                        }
                    } else if (tabName === 'historique') {
                        setTimeout(() => chargerHistorique(), 100);
                    }
                }
            } catch (error) {
                console.error('Erreur switchTab:', error);
            }
        }

        // ========== GESTION DES FICHIERS ==========
        function setupFileHandlers() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    currentData = parseExcelData(jsonData);
                    
                    if (currentData.length === 0) {
                        alert('‚ùå Aucune donn√©e d√©tect√©e. V√©rifiez le format de votre fichier.');
                        return;
                    }
                    
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('rowCount').textContent = currentData.length;
                    
                } catch (error) {
                    console.error('Erreur handleFile:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier : ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelData(data) {
    if (data.length < 2) {
        console.error('‚ùå Fichier vide ou incomplet');
        return [];
    }
    
    // Afficher les en-t√™tes pour debug
    console.log('üìã En-t√™tes d√©tect√©s:', data[0]);
    
    const headers = data[0].map(h => String(h).toLowerCase().trim());
    console.log('üìã En-t√™tes normalis√©s:', headers);
    
    // Recherche intelligente des colonnes
    const findColumn = (keywords) => {
        for (let keyword of keywords) {
            const index = headers.findIndex(h => h.includes(keyword));
            if (index !== -1) {
                console.log(`‚úÖ Colonne "${keyword}" trouv√©e √† l'index ${index}`);
                return index;
            }
        }
        console.warn(`‚ö†Ô∏è Aucune colonne trouv√©e pour: ${keywords.join(', ')}`);
        return -1;
    };
    
    // Mapping des colonnes avec plusieurs variantes possibles
    const codeIndex = findColumn(['code', 'client', 'compte']);
    const nomIndex = findColumn(['nom', 'raison', 'intitul√©', 'libell√©', 'libelle']);
    const soldeIndex = findColumn(['solde', 'balance', 'total']);
    const e0Index = findColumn(['0-30', '0 30', 'courant', '30j', '0√†30', '0 √† 30']);
    const e30Index = findColumn(['30-60', '30 60', '60j', '30√†60', '30 √† 60']);
    const e60Index = findColumn(['60-90', '60 90', '90j', '60√†90', '60 √† 90']);
    const e90Index = findColumn(['90-120', '90 120', '120j', '90√†120', '90 √† 120']);
    const e120Index = findColumn(['120', '>120', 'plus120', '+ 120', 'sup 120']);
    const paiementIndex = findColumn(['paiement', 'r√®glement', 'reglement', 'encaissement']);
    
    // V√©rification des colonnes obligatoires
    if (codeIndex === -1 || nomIndex === -1) {
        console.error('‚ùå Colonnes obligatoires manquantes (Code ou Nom)');
        alert('‚ùå Format invalide : colonnes "Code Client" et "Nom Client" introuvables');
        return [];
    }
    
    // Parser les donn√©es
    const parsedData = data.slice(1)
        .map((row, index) => {
            const client = {
                codeClient: String(row[codeIndex] || '').trim(),
                nomClient: String(row[nomIndex] || '').trim(),
                solde: soldeIndex !== -1 ? parseFloat(row[soldeIndex]) || 0 : 0,
                echeance0: e0Index !== -1 ? parseFloat(row[e0Index]) || 0 : 0,
                echeance30: e30Index !== -1 ? parseFloat(row[e30Index]) || 0 : 0,
                echeance60: e60Index !== -1 ? parseFloat(row[e60Index]) || 0 : 0,
                echeance90: e90Index !== -1 ? parseFloat(row[e90Index]) || 0 : 0,
                echeancePlus120: e120Index !== -1 ? parseFloat(row[e120Index]) || 0 : 0,
                paiement: paiementIndex !== -1 ? parseFloat(row[paiementIndex]) || 0 : 0
            };
            
            // Log de la premi√®re ligne pour v√©rification
            if (index === 0) {
                console.log('üìä Premier client pars√©:', client);
            }
            
            return client;
        })
        .filter(c => {
            // Filtrer les lignes vides ou invalides
            const isValid = c.codeClient && c.nomClient && c.codeClient !== '' && c.nomClient !== '';
            if (!isValid && c.codeClient) {
                console.warn('‚ö†Ô∏è Ligne ignor√©e:', c);
            }
            return isValid;
        });
    
    console.log(`‚úÖ ${parsedData.length} clients valides d√©tect√©s`);
    
    return parsedData;
}


        // ========== IMPORT ==========
        async function importerBalance() {
            if (!API_URL) {
                alert('‚ùå Veuillez d\'abord configurer l\'URL de votre API');
                switchTab('config');
                return;
            }
            
            const agence = document.getElementById('agenceSelect').value;
            if (!agence) {
                alert('‚ùå Veuillez s√©lectionner une agence');
                return;
                          }
          
          if (currentData.length === 0) {
              alert('‚ùå Veuillez d\'abord charger un fichier Excel');
              return;
          }
          
          showLoading();
          
          try {
              const payload = {
                  action: 'importerBalance',
                  data: currentData,
                  agence: agence,
                  email: USER_EMAIL,
                  nom: USER_NAME
              };
              
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  alert(`‚úÖ ${result.message}\nVersion: ${result.version}\nNombre de clients: ${result.nbClients}`);
                  showSaveIndicator();
                  
                  // R√©initialiser
                  currentData = [];
                  document.getElementById('fileInfo').classList.add('hidden');
                  document.getElementById('fileInput').value = '';
              } else {
                  alert('‚ùå Erreur : ' + result.message);
              }
          } catch (error) {
              console.error('‚ùå Erreur importerBalance:', error);
              alert('‚ùå Erreur lors de l\'import : ' + error.message);
          } finally {
              hideLoading();
          }
      }

      // ========== CHARGEMENT ET ANALYSE ==========
      async function chargerEtAnalyser() {
          if (!API_URL) {
              alert('‚ùå Veuillez d\'abord configurer l\'URL de votre API');
              switchTab('config');
              return;
          }
          
          const agence = document.getElementById('analyseAgence').value;
          const version = document.getElementById('analyseVersion').value;
          
          if (!agence) {
              alert('‚ùå Veuillez s√©lectionner une agence');
              return;
          }
          
          showLoading();
          
          try {
              const response = await fetch(`${API_URL}?action=chargerBalance&agence=${agence}&version=${version}`);
              const result = await response.json();
              
              if (result.success) {
                  analysisData = result.clients || [];
                  
                  if (analysisData.length === 0) {
                      alert('‚ö†Ô∏è Aucune donn√©e disponible pour cette agence/version');
                      return;
                  }
                  
                  analyserDonnees();
                  document.getElementById('analysisResults').classList.remove('hidden');
              } else {
                  alert('‚ùå Erreur : ' + result.message);
              }
              
          } catch (error) {
              console.error('‚ùå Erreur chargerEtAnalyser:', error);
              alert('‚ùå Erreur lors du chargement : ' + error.message);
          } finally {
              hideLoading();
          }
      }

      function analyserDonnees() {
          try {
              // Calcul des KPIs
              const soldesDebiteurs = analysisData.filter(c => c.solde > 0).reduce((sum, c) => sum + c.solde, 0);
              const soldesCrediteurs = Math.abs(analysisData.filter(c => c.solde < 0).reduce((sum, c) => sum + c.solde, 0));
              const balanceTotale = soldesDebiteurs - soldesCrediteurs;
              
              // Clients √† risque
              const clientsCritiques = analysisData.filter(c => 
                  (c.echeance90 || 0) + (c.echeancePlus120 || 0) > 1000 || c.solde > 10000
              ).length;
              
              // Taux de risque
              const montantPlus90 = analysisData.reduce((sum, c) => 
                  sum + (c.echeance90 || 0) + (c.echeancePlus120 || 0), 0
              );
              const tauxRisque = soldesDebiteurs > 0 ? ((montantPlus90 / soldesDebiteurs) * 100).toFixed(1) : 0;

              // Afficher les KPIs
              document.getElementById('soldesDebiteurs').textContent = formatCurrency(soldesDebiteurs);
              document.getElementById('soldesCrediteurs').textContent = formatCurrency(soldesCrediteurs);
              document.getElementById('balanceTotale').textContent = formatCurrency(balanceTotale);
              document.getElementById('clientsCritiques').textContent = clientsCritiques;
              document.getElementById('tauxRisque').textContent = tauxRisque + '%';

              // Afficher le tableau
              displayClientsTable();

              // Afficher les graphiques
              displayCharts();
          } catch (error) {
              console.error('Erreur analyserDonnees:', error);
              alert('‚ùå Erreur lors de l\'analyse : ' + error.message);
          }
      }

      function displayClientsTable() {
          const tbody = document.getElementById('clientsTableBody');
          tbody.innerHTML = '';

          // Trier par solde d√©croissant
          const sortedData = [...analysisData].sort((a, b) => b.solde - a.solde);

          sortedData.forEach(client => {
              const row = document.createElement('tr');
              row.className = 'border-b hover:bg-gray-50';

              // D√©terminer le niveau de risque
              const montantPlus90 = (client.echeance90 || 0) + (client.echeancePlus120 || 0);
              let risqueClass = 'bg-green-100 text-green-800';
              let risqueText = 'Faible';
              
              if (montantPlus90 > 5000 || client.solde > 20000) {
                  risqueClass = 'bg-red-100 text-red-800';
                  risqueText = '√âlev√©';
              } else if (montantPlus90 > 3000 || client.solde > 10000) {
                  risqueClass = 'bg-orange-100 text-orange-800';
                  risqueText = 'Moyen';
              }

              row.innerHTML = `
                  <td class="px-4 py-3 font-mono text-sm">${client.codeClient}</td>
                  <td class="px-4 py-3">${client.nomClient}</td>
                  <td class="px-4 py-3 text-right font-semibold ${client.solde > 0 ? 'text-red-600' : 'text-green-600'}">
                      ${formatCurrency(client.solde)}
                  </td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.echeance0 || 0)}</td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.echeance30 || 0)}</td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.echeance60 || 0)}</td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.echeance90 || 0)}</td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.echeancePlus120 || 0)}</td>
                  <td class="px-4 py-3 text-right">${formatCurrency(client.paiement || 0)}</td>
                  <td class="px-4 py-3 text-center">
                      <span class="px-2 py-1 rounded text-xs font-semibold ${risqueClass}">${risqueText}</span>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      function displayCharts() {
          try {
              // Graphique par anciennet√©
              const totalE0 = analysisData.reduce((sum, c) => sum + (c.echeance0 || 0), 0);
              const totalE30 = analysisData.reduce((sum, c) => sum + (c.echeance30 || 0), 0);
              const totalE60 = analysisData.reduce((sum, c) => sum + (c.echeance60 || 0), 0);
              const totalE90 = analysisData.reduce((sum, c) => sum + (c.echeance90 || 0), 0);
              const totalE120 = analysisData.reduce((sum, c) => sum + (c.echeancePlus120 || 0), 0);

              const ctxAge = document.getElementById('ageChart').getContext('2d');
              if (ageChartInstance) ageChartInstance.destroy();
              ageChartInstance = new Chart(ctxAge, {
                  type: 'doughnut',
                  data: {
                      labels: ['0-30j', '30-60j', '60-90j', '90-120j', '>120j'],
                      datasets: [{
                          data: [totalE0, totalE30, totalE60, totalE90, totalE120],
                          backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#7c3aed']
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      plugins: {
                          legend: { position: 'bottom' },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      return context.label + ': ' + formatCurrency(context.raw);
                                  }
                              }
                          }
                      }
                  }
              });

              // Top 10 clients
              const top10 = [...analysisData]
                  .filter(c => c.solde > 0)
                  .sort((a, b) => b.solde - a.solde)
                  .slice(0, 10);

              const ctxTop = document.getElementById('topClientsChart').getContext('2d');
              if (topClientsChartInstance) topClientsChartInstance.destroy();
              topClientsChartInstance = new Chart(ctxTop, {
                  type: 'bar',
                  data: {
                      labels: top10.map(c => c.nomClient.substring(0, 20)),
                      datasets: [{
                          label: 'Solde (‚Ç¨)',
                          data: top10.map(c => c.solde),
                          backgroundColor: '#3b82f6'
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      indexAxis: 'y',
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      return formatCurrency(context.raw);
                                  }
                              }
                          }
                      },
                      scales: {
                          x: {
                              beginAtZero: true,
                              ticks: {
                                  callback: function(value) {
                                      return formatCurrency(value);
                                  }
                              }
                          }
                      }
                  }
              });
          } catch (error) {
              console.error('Erreur displayCharts:', error);
          }
      }

      // ========== GESTION DES VERSIONS ==========
      async function chargerVersions() {
          if (!API_URL) {
              alert('‚ùå Veuillez d\'abord configurer l\'URL de votre API');
              return;
          }
          
          const agence = document.getElementById('versionsAgence').value;
          
          if (!agence) {
              document.getElementById('versionsList').innerHTML = `
                  <div class="bg-gray-50 border rounded-lg p-4">
                      <p class="text-gray-600">Veuillez s√©lectionner une agence</p>
                  </div>
              `;
              return;
          }
          
          showLoading();
          
          try {
              const response = await fetch(`${API_URL}?action=listerVersions&agence=${agence}`);
              const result = await response.json();
              
              if (result.success && result.versions) {
                  displayVersionsList(result.versions);
                  
                  // Mettre √† jour le select de l'onglet analyse
                  const selectAnalyse = document.getElementById('analyseVersion');
                  selectAnalyse.innerHTML = '<option value="latest">Derni√®re version</option>';
                  result.versions.forEach(v => {
                      const option = document.createElement('option');
                      option.value = v.version;
                      option.textContent = `${v.version} - ${v.date} ${v.heure}`;
                      selectAnalyse.appendChild(option);
                  });
              } else {
                  document.getElementById('versionsList').innerHTML = `
                      <div class="bg-gray-50 border rounded-lg p-4">
                          <p class="text-gray-600">Aucune version trouv√©e pour cette agence</p>
                      </div>
                  `;
              }
          } catch (error) {
              console.error('‚ùå Erreur chargerVersions:', error);
              document.getElementById('versionsList').innerHTML = `
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p class="text-red-800">‚ùå Erreur lors du chargement des versions</p>
                  </div>
              `;
          } finally {
              hideLoading();
          }
      }

      function displayVersionsList(versions) {
          const container = document.getElementById('versionsList');
          
          if (versions.length === 0) {
              container.innerHTML = `
                  <div class="bg-gray-50 border rounded-lg p-4">
                      <p class="text-gray-600">Aucune version trouv√©e</p>
                  </div>
              `;
              return;
          }
          
          container.innerHTML = versions.map(version => `
              <div class="version-card" onclick="chargerVersionSpecifique('${version.agence}', '${version.version}')">
                  <div class="flex justify-between items-start mb-2">
                      <div>
                          <h3 class="font-semibold text-lg">${version.version}</h3>
                          <p class="text-sm text-gray-600">Par ${version.utilisateur || 'Inconnu'}</p>
                      </div>
                      <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                          ${version.date} ${version.heure}
                      </span>
                  </div>
                  <div class="text-sm text-gray-600">
                      <span>üìä ${version.nbClients || 0} clients</span>
                  </div>
              </div>
          `).join('');
      }

      async function chargerVersionSpecifique(agence, version) {
          if (!confirm(`Charger la version ${version} de l'agence ${agence} ?`)) return;
          
          document.getElementById('analyseAgence').value = agence;
          document.getElementById('analyseVersion').value = version;
          
          switchTab('analyse');
          
          await chargerEtAnalyser();
      }

      // ========== HISTORIQUE ==========
      async function chargerHistorique() {
          if (!API_URL) {
              alert('‚ùå Veuillez d\'abord configurer l\'URL de votre API');
              return;
          }
          
          showLoading();
          
          try {
              const response = await fetch(`${API_URL}?action=getHistorique`);
              const result = await response.json();
              
              if (result.success && result.historique) {
                  displayHistorique(result.historique);
              } else {
                  document.getElementById('historiqueList').innerHTML = `
                      <div class="bg-gray-50 border rounded-lg p-4">
                          <p class="text-gray-600">Aucun historique disponible</p>
                      </div>
                  `;
              }
          } catch (error) {
              console.error('‚ùå Erreur chargerHistorique:', error);
              document.getElementById('historiqueList').innerHTML = `
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p class="text-red-800">‚ùå Erreur lors du chargement de l'historique</p>
                  </div>
              `;
          } finally {
              hideLoading();
          }
      }

      function displayHistorique(historique) {
          const container = document.getElementById('historiqueList');
          
          if (historique.length === 0) {
              container.innerHTML = `
                  <div class="bg-gray-50 border rounded-lg p-4">
                      <p class="text-gray-600">Aucun historique disponible</p>
                  </div>
              `;
              return;
          }
          
          container.innerHTML = `
              <div class="overflow-x-auto bg-white border rounded-lg">
                  <table class="w-full text-sm">
                      <thead class="bg-gray-100">
                          <tr>
                              <th class="px-4 py-3 text-left">Date</th>
                              <th class="px-4 py-3 text-left">Heure</th>
                              <th class="px-4 py-3 text-left">Agence</th>
                              <th class="px-4 py-3 text-left">Version</th>
                              <th class="px-4 py-3 text-left">Utilisateur</th>
                              <th class="px-4 py-3 text-right">Nb Clients</th>
                              <th class="px-4 py-3 text-left">Action</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${historique.map(h => `
                              <tr class="border-b hover:bg-gray-50">
                                  <td class="px-4 py-3">${h.date}</td>
                                  <td class="px-4 py-3">${h.heure}</td>
                                  <td class="px-4 py-3">${h.agence}</td>
                                  <td class="px-4 py-3 font-mono">${h.version}</td>
                                  <td class="px-4 py-3">${h.utilisateur}</td>
                                  <td class="px-4 py-3 text-right">${h.nbClients}</td>
                                  <td class="px-4 py-3">${h.action}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      // ========== EXPORT ==========
      function exportToExcel() {
          if (analysisData.length === 0) {
              alert('‚ùå Aucune donn√©e √† exporter');
              return;
          }
          
          try {
              const ws = XLSX.utils.json_to_sheet(analysisData.map(c => ({
                  'Code Client': c.codeClient,
                  'Nom Client': c.nomClient,
                  'Solde': c.solde,
                  '0-30j': c.echeance0 || 0,
                  '30-60j': c.echeance30 || 0,
                  '60-90j': c.echeance60 || 0,
                  '90-120j': c.echeance90 || 0,
                  '>120j': c.echeancePlus120 || 0,
                  'Paiement': c.paiement || 0
              })));
              
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Balance √Çg√©e');
              
              const agence = document.getElementById('analyseAgence').value;
              const version = document.getElementById('analyseVersion').value;
              const fileName = `Balance_Agee_${agence}_${version}_${new Date().toISOString().split('T')[0]}.xlsx`;
              XLSX.writeFile(wb, fileName);
          } catch (error) {
              console.error('Erreur exportToExcel:', error);
              alert('‚ùå Erreur lors de l\'export : ' + error.message);
          }
      }

      // ========== UTILITAIRES ==========
      function formatCurrency(value) {
          return new Intl.NumberFormat('fr-FR', {
              style: 'currency',
              currency: 'EUR',
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
          }).format(value);
      }

      function showSaveIndicator() {
          const indicator = document.getElementById('saveIndicator');
          indicator.style.display = 'block';
          setTimeout(() => {
              indicator.style.display = 'none';
          }, 2000);
      }
  </script>
</body>
</html>

            

