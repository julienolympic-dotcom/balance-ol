<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance √Çg√©e OL - Version 6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .comment-input-cell {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 40px;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .comment-input-cell:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .comment-input-cell.has-comment {
            background-color: #fef3c7;
            border-color: #f59e0b;
            font-weight: 500;
        }
        .comment-history-item {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #3b82f6;
            position: relative;
        }
        .comment-history-item .author {
            font-weight: bold;
            color: #1f2937;
            font-size: 0.875rem;
        }
        .comment-history-item .timestamp {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .comment-history-item .text {
            margin-top: 6px;
            color: #374151;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        .comment-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .comment-history-item:hover .comment-delete-btn {
            opacity: 1;
        }
        .comment-delete-btn:hover {
            background: #dc2626;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            display: none;
            z-index: 2000;
            animation: fadeInOut 2s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Indicateur de sauvegarde -->
    <div class="save-indicator" id="saveIndicator">‚úì Sauvegarde effectu√©e</div>

    <!-- Modal Commentaires -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üí¨ Commentaires Client</h3>
            <div class="bg-blue-50 p-3 rounded mb-4">
                <p class="text-sm"><strong>Code:</strong> <span id="modalClientCode"></span></p>
                <p class="text-sm"><strong>Nom:</strong> <span id="modalClientName"></span></p>
                <p class="text-sm"><strong>Solde:</strong> <span id="modalClientSolde"></span></p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nom de l'utilisateur :</label>
                <input type="text" id="commentAuthor" class="w-full border rounded px-3 py-2" placeholder="Votre nom">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Historique des commentaires :</label>
                <div id="commentHistory" class="max-h-48 overflow-y-auto"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau commentaire :</label>
                <textarea id="newCommentText" class="w-full border rounded px-3 py-2" rows="3" placeholder="Entrez votre commentaire..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeCommentModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Annuler
                </button>
                <button onclick="saveNewComment()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è Confirmation de suppression</h3>
            <p class="text-gray-700 mb-4">√ätes-vous s√ªr de vouloir supprimer ce client ?</p>
            <div id="deleteClientInfo" class="text-sm text-gray-600 mb-4 bg-gray-100 p-3 rounded"></div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-sm text-yellow-800">
                    <strong>‚ö†Ô∏è Important :</strong> S'il s'agit d'un partenariat, vous devez entreprendre les d√©marches n√©cessaires pour le d√©clarer (CERFA).
                </p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Votre nom :</label>
                <input type="text" id="deleteAuthor" class="w-full border rounded px-3 py-2" placeholder="Votre nom">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Raison de la suppression :</label>
                <textarea id="deleteReason" class="w-full border rounded px-3 py-2" rows="3" placeholder="Expliquez la raison de cette suppression..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Annuler
                </button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Confirmer la suppression
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üè¶ Balance √Çg√©e OL - Version 6.0</h1>
            <p class="text-gray-600">Analyse compl√®te avec synchronisation cloud</p>
        </div>

        <!-- Section Configuration -->
        <div id="configSection" class="bg-white rounded-lg shadow-md p-6 mb-8 no-print">
            <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Agence :</label>
                    <select id="agenceSelect" class="w-full border rounded px-3 py-2">
                        <option value="00">00 - G√®ze</option>
                        <option value="01">01 - 5 Av</option>
                        <option value="02">02 - Gare St Charles</option>
                        <option value="03">03 - Aubagne</option>
                        <option value="06">06 - La Valentine</option>
                        <option value="08">08 - Toulon</option>
                        <option value="09">09 - Plombi√®res</option>
                        <option value="12">12 - La Garde</option>
                        <option value="13">13 - La Ciotat</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Votre nom :</label>
                    <input type="text" id="userName" class="w-full border rounded px-3 py-2" placeholder="Ex: Julien">
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-700">
                    <strong>üí° Info :</strong> Les donn√©es seront automatiquement sauvegard√©es dans Google Sheets pour votre agence.
                </p>
            </div>
        </div>

        <div id="uploadSection" class="bg-white rounded-lg shadow-md p-6 mb-8 no-print">
            <h2 class="text-xl font-semibold mb-4">üì§ Charger votre fichier Excel</h2>
            
            <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-gray-600 mb-2">Glissez-d√©posez votre fichier Excel ici</p>
                <p class="text-sm text-gray-500">ou</p>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv">
                <button onclick="document.getElementById('fileInput').click()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Parcourir
                </button>
            </div>

            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">üí° M√©thode de calcul :</h3>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>‚Ä¢ La <strong>balance totale</strong> = diff√©rence entre soldes d√©biteurs et soldes cr√©diteurs</li>
                    <li>‚Ä¢ Les <strong>soldes d√©biteurs</strong> = clients qui nous doivent de l'argent (positifs)</li>
                    <li>‚Ä¢ Les <strong>soldes cr√©diteurs</strong> = clients √† qui nous devons de l'argent (n√©gatifs)</li>
                    <li>‚Ä¢ Les tranches d'anciennet√© montrent la composition de ces soldes</li>
                </ul>
            </div>
        </div>

        <div id="loadingIndicator" class="loading bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center">
                <div class="animate-pulse mr-4">
                    <div class="h-4 w-4 bg-blue-500 rounded-full"></div>
                </div>
                <p class="text-gray-600">Analyse et import en cours...</p>
            </div>
        </div>

        <div id="analysisResults" class="hidden">
            <!-- Zone Chiffre d'Affaires -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border-2 border-purple-200">
                <h2 class="text-xl font-semibold mb-4 text-purple-800">üíº Calcul du Taux d'Impay√©s</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chiffre d'Affaires Annuel (‚Ç¨)</label>
                        <input type="number" id="chiffreAffaires" class="w-full border-2 border-purple-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none" placeholder="Ex: 1000000" min="0">
                    </div>
                    <div>
                        <button onclick="calculateTauxImpaye()" class="w-full bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-semibold">
                            Calculer le Taux d'Impay√©s
                        </button>
                    </div>
                    <div id="tauxImpayeResult" class="hidden bg-white rounded-lg p-4 border-2 border-purple-300">
                        <p class="text-sm text-gray-600">Taux d'Impay√©s</p>
                        <p id="tauxImpayeValue" class="text-2xl font-bold"></p>
                        <p id="tauxImpayeStatus" class="text-xs mt-1"></p>
                    </div>
                </div>
                <div class="mt-3 text-sm text-purple-700">
                    <strong>Objectif :</strong> Maintenir le taux d'impay√©s <strong>sous 2%</strong> pour une gestion saine
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">üìä Synth√®se Globale</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="bg-red-50 rounded-lg p-4">
                        <p class="text-sm text-red-600">Soldes D√©biteurs</p>
                        <p id="soldesDebiteurs" class="text-2xl font-bold text-red-800">-</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-green-600">Soldes Cr√©diteurs</p>
                        <p id="soldesCrediteurs" class="text-2xl font-bold text-green-800">-</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-blue-600">Balance Totale</p>
                        <p id="balanceTotale" class="text-2xl font-bold text-blue-800">-</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <p class="text-sm text-orange-600">Clients > 90j</p>
                        <p id="clientsCritiques" class="text-2xl font-bold text-orange-800">-</p>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <p class="text-sm text-yellow-600">Taux de risque</p>
                        <p id="tauxRisque" class="text-2xl font-bold text-yellow-800">-</p>
                    </div>
                </div>
                
                <div class="mt-4 bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-purple-600">Nombre de clients</p>
                            <p id="nombreClients" class="text-xl font-bold text-purple-800">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-purple-600">Montant √† risque (>60j)</p>
                            <p id="montantRisque" class="text-xl font-bold text-purple-800">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">R√©partition des soldes par anciennet√©</h3>
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Top 10 soldes √† risque</h3>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">üìã D√©tail par Client</h2>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                    <div>
                        <label class="text-sm text-gray-600">Filtrer par niveau de risque:</label>
                        <select id="riskFilter" class="w-full mt-1 border rounded px-3 py-2">
                            <option value="all">Tous</option>
                            <option value="critical">Critique (>90j)</option>
                            <option value="high">√âlev√© (60-90j)</option>
                            <option value="medium">Mod√©r√© (30-60j)</option>
                            <option value="low">Faible (<30j)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Type de solde:</label>
                        <select id="soldeTypeFilter" class="w-full mt-1 border rounded px-3 py-2">
                            <option value="all">Tous</option>
                            <option value="debiteur">D√©biteurs uniquement</option>
                            <option value="crediteur">Cr√©diteurs uniquement</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Solde minimum (valeur absolue):</label>
                        <input type="number" id="minBalance" class="w-full mt-1 border rounded px-3 py-2" placeholder="0" min="0">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                           <tr>
                                <th onclick="sortTable('code')" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                   Code Client
                                </th>
                                <th onclick="sortTable('nom')" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Nom Client
                                </th>
                                <th onclick="sortTable('solde')" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Solde
                                </th>
                                <th onclick="sortTable('anciennete')" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    % Anciennet√©
                                </th>
                                <th onclick="sortTable('risque')" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Risque
                                </th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="min-width: 200px;">Commentaire</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Supprimer</th>
                           </tr>
                        </thead>
                        <tbody id="detailsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">üéØ Actions Recommand√©es</h2>
                
                <!-- Alerte Urgent -->
                <div id="urgentAlert" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
                    <h3 class="font-semibold text-red-800 mb-2">üö® <span id="urgentTitle"></span></h3>
                    <p class="text-sm text-red-700" id="urgentText"></p>
                </div>

                <!-- Alerte Taux de risque -->
                <div id="riskAlert" class="hidden bg-orange-50 border-l-4 border-orange-500 p-4 rounded mb-4">
                    <h3 class="font-semibold text-orange-800 mb-2">‚ö†Ô∏è <span id="riskTitle"></span></h3>
                    <p class="text-sm text-orange-700" id="riskText"></p>
                    <ul class="text-sm text-orange-700 mt-2 space-y-1 list-disc list-inside">
                        <li>Contacter imm√©diatement tous les clients avec soldes > 90 jours</li>
                        <li>Suspendre les locations pour les clients √† risque</li>
                    </ul>
                </div>

                <!-- Concentration du risque -->
                <div id="riskConcentrationCard" class="hidden bg-white border border-gray-200 p-4 rounded mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">üìä Concentration du risque</h3>
                    <p id="riskConcentrationText" class="text-gray-600 mb-3 text-sm"></p>
                    <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
                        <li>Prioriser le recouvrement aupr√®s de ces clients.</li>
                          <li>√âtablir un suivi hebdomadaire personnalis√©.</li>
                          <li>√âvaluer l'opportunit√© d'une action en justice si n√©cessaire.</li>
                      </ul>
                  </div>

                  <!-- Clients critiques √† contacter -->
                  <div id="criticalClientsCard" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                      <h3 class="font-semibold text-yellow-800 mb-2">üìû Clients critiques √† contacter</h3>
                      <p class="text-sm text-yellow-700 mb-3" id="criticalClientsCount"></p>
                      <div class="bg-white rounded p-3 mb-3">
                          <p class="text-xs font-semibold text-gray-600 mb-2">Liste des clients :</p>
                          <ul id="criticalClientsList" class="text-xs text-gray-700 space-y-1"></ul>
                      </div>
                      <ul class="text-sm text-yellow-700 space-y-1 list-disc list-inside">
                          <li>Prioriser les relances t√©l√©phoniques</li>
                          <li>Envoyer des mises en demeure si n√©cessaire</li>
                      </ul>
                  </div>
              </div>

              <div class="bg-white rounded-lg shadow-md p-6 no-print">
                                      <h2 class="text-xl font-semibold mb-4">üíæ Export des R√©sultats</h2>
                    <div class="flex space-x-4 flex-wrap gap-2">
                        <button onclick="exportToExcel()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            üìä Exporter en Excel
                        </button>
                        <button onclick="saveAsHTML()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            üíæ Sauvegarder HTML (avec commentaires)
                        </button>
                        <button onclick="window.print()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            üìÑ Imprimer
                        </button>
                    </div>
                    <div class="mt-3 text-sm text-gray-600">
                        <strong>üí° Astuce :</strong> Le fichier HTML sauvegard√© contient tous vos commentaires et peut √™tre partag√© par email. Il s'ouvre directement dans n'importe quel navigateur !
                    </div>
                </div>
            </div>
        </div>

    <script>
        // ============================================
        // CONFIGURATION API
        // ============================================
        const API_CONFIG = {
            workerUrl: 'https://balance-agee-ol.julien-delamare.workers.dev',
            agencesMap: {
                '00': 'G√®ze',
                '01': '5 Av',
                '02': 'Gare St Charles',
                '03': 'Aubagne',
                '06': 'La Valentine',
                '08': 'Toulon',
                '09': 'Plombi√®res',
                '12': 'La Garde',
                '13': 'La Ciotat'
            }
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let analysisData = null;
        let ageChart = null;
        let riskChart = null;
        let allDataGlobal = [];
        let clientToDelete = null;
        let commentsData = {};
        let currentCommentClient = null;
        let currentSortColumn = 'solde';
        let currentSortDirection = 'desc';

        // ============================================
        // GESTION DES COMMENTAIRES
        // ============================================
        function loadComments() {
            const saved = localStorage.getItem('balanceAgeeComments');
            if (saved) {
                try {
                    commentsData = JSON.parse(saved);
                    console.log('üí¨ Commentaires charg√©s:', commentsData);
                } catch (e) {
                    console.error('‚ùå Erreur chargement commentaires:', e);
                    commentsData = {};
                }
            }
        }

        function saveComments() {
            localStorage.setItem('balanceAgeeComments', JSON.stringify(commentsData));
            console.log('üíæ Commentaires sauvegard√©s:', commentsData);
            showSaveIndicator();
        }

        async function syncCommentsToCloud(agence, clientCode, comment) {
            try {
                const response = await fetch(`${API_CONFIG.workerUrl}?action=ajouterCommentaire`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agence: agence,
                        codeClient: clientCode,
                        author: comment.author,
                        text: comment.text,
                        timestamp: comment.timestamp
                    })
                });
                
                const result = await response.json();
                console.log('‚òÅÔ∏è Commentaire synchronis√©:', result);
                return result.success;
            } catch (error) {
                console.error('‚ùå Erreur sync commentaire:', error);
                return false;
            }
        }

        function openCommentModal(clientCode, clientName, clientSolde) {
            currentCommentClient = clientCode;
            document.getElementById('modalClientCode').textContent = clientCode;
            document.getElementById('modalClientName').textContent = clientName;
            document.getElementById('modalClientSolde').textContent = formatCurrency(clientSolde);
            
            const history = Array.isArray(commentsData[clientCode]) ? commentsData[clientCode] : [];
            const historyDiv = document.getElementById('commentHistory');
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun commentaire pour ce client.</p>';
            } else {
                historyDiv.innerHTML = history.map((comment, index) => `
                    <div class="comment-history-item">
                        <button class="comment-delete-btn" onclick="deleteComment(${index})" title="Supprimer ce commentaire">
                            üóëÔ∏è Supprimer
                        </button>
                        <div class="flex justify-between items-start" style="padding-right: 80px;">
                            <span class="author">üë§ ${comment.author || 'Anonyme'}</span>
                            <span class="timestamp">${new Date(comment.timestamp).toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="text">${comment.text || ''}</div>
                    </div>
                `).join('');
            }
            
            document.getElementById('newCommentText').value = '';
            document.getElementById('commentModal').classList.add('active');
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.remove('active');
            currentCommentClient = null;
        }

        async function saveNewComment() {
            const author = document.getElementById('commentAuthor').value.trim();
            const text = document.getElementById('newCommentText').value.trim();
            
            if (!author) {
                alert('Veuillez entrer votre nom.');
                return;
            }
            
            if (!text) {
                alert('Veuillez entrer un commentaire.');
                return;
            }
            
            if (!Array.isArray(commentsData[currentCommentClient])) {
                commentsData[currentCommentClient] = [];
            }
            
            const newComment = {
                author: author,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            commentsData[currentCommentClient].push(newComment);
            
            saveComments();
            
            // Synchroniser avec le cloud
            const agence = document.getElementById('agenceSelect').value;
            await syncCommentsToCloud(agence, currentCommentClient, newComment);
            
            closeCommentModal();
            fillDetailsTable(applyFilters(allDataGlobal));
        }

        function deleteComment(commentIndex) {
            if (!currentCommentClient) return;
            
            const clientComments = commentsData[currentCommentClient];
            if (!Array.isArray(clientComments) || commentIndex >= clientComments.length) return;
            
            const comment = clientComments[commentIndex];
            const confirmMsg = `√ätes-vous s√ªr de vouloir supprimer ce commentaire ?\n\n` +
                                 `Auteur: ${comment.author}\n` +
                                 `Date: ${new Date(comment.timestamp).toLocaleString('fr-FR')}\n` +
                                 `Texte: ${comment.text.substring(0, 100)}${comment.text.length > 100 ? '...' : ''}`;
            
            if (!confirm(confirmMsg)) return;
            
            commentsData[currentCommentClient].splice(commentIndex, 1);
            
            if (commentsData[currentCommentClient].length === 0) {
                delete commentsData[currentCommentClient];
            }
            
            saveComments();
            
            const clientCode = currentCommentClient;
            const clientName = document.getElementById('modalClientName').textContent;
            const clientSoldeText = document.getElementById('modalClientSolde').textContent;
            const clientSolde = parseFloat(clientSoldeText.replace(/[^0-9,-]/g, '').replace(',', '.'));
            
            openCommentModal(clientCode, clientName, clientSolde);
            fillDetailsTable(applyFilters(allDataGlobal));
            showDeleteNotification();
        }

        function showDeleteNotification() {
            const notification = document.createElement('div');
            notification.className = 'save-indicator';
            notification.textContent = 'üóëÔ∏è Commentaire supprim√©';
            notification.style.display = 'block';
            notification.style.background = '#ef4444';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ============================================
        // GESTION DE LA SUPPRESSION CLIENT
        // ============================================
        function openDeleteModal(clientCode, clientName, clientSolde) {
            clientToDelete = { code: clientCode, name: clientName, solde: clientSolde };
            document.getElementById('deleteClientInfo').innerHTML = `
                <strong>Code:</strong> ${clientCode}<br>
                <strong>Nom:</strong> ${clientName}<br>
                <strong>Solde:</strong> ${formatCurrency(clientSolde)}
            `;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            clientToDelete = null;
            document.getElementById('deleteReason').value = '';
        }

        function confirmDelete() {
            const author = document.getElementById('deleteAuthor').value.trim();
            const reason = document.getElementById('deleteReason').value.trim();
            
            if (!author) {
                alert('Veuillez entrer votre nom.');
                return;
            }
            
            if (!reason) {
                alert('Veuillez indiquer la raison de la suppression.');
                return;
            }
            
            const deletionRecord = {
                author: author,
                text: `üóëÔ∏è CLIENT SUPPRIM√â - Raison: ${reason}`,
                timestamp: new Date().toISOString()
            };
            
            if (!Array.isArray(commentsData[clientToDelete.code])) {
                commentsData[clientToDelete.code] = [];
            }
            commentsData[clientToDelete.code].push(deletionRecord);
            
            allDataGlobal = allDataGlobal.filter(row => row.codeClient !== clientToDelete.code);
            analysisData.allData = allDataGlobal;
            analysisData.summary = calculateSummary(allDataGlobal);
            
            saveComments();
            displayResults(analysisData);
            closeDeleteModal();
            
            alert(`Client ${clientToDelete.name} supprim√© avec succ√®s.`);
        }

        // ============================================
        // GESTION DES FICHIERS
        // ============================================
        async function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls|csv)$/)) {
                alert('Veuillez s√©lectionner un fichier Excel (.xlsx, .xls) ou CSV');
                return;
            }
            
            const agence = document.getElementById('agenceSelect').value;
            const userName = document.getElementById('userName').value.trim();
            
            if (!userName) {
                alert('Veuillez entrer votre nom avant de charger un fichier.');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('active');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                    analysisData = analyzeWorkbook(workbook);
                    
                    // Afficher les r√©sultats localement
                    displayResults(analysisData);
                    document.getElementById('analysisResults').classList.remove('hidden');
                    document.getElementById('uploadSection').classList.add('hidden');
                    
                    // Importer vers Google Sheets
                    await importToSheets(agence, analysisData.allData, userName);
                    
                    document.getElementById('loadingIndicator').classList.remove('active');
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'analyse:', error);
                    alert('Erreur lors de l\'analyse du fichier. V√©rifiez le format.');
                    document.getElementById('loadingIndicator').classList.remove('active');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function importToSheets(agence, clients, userName) {
            try {
                console.log(`üì§ Envoi de ${clients.length} clients pour l'agence ${agence}`);
                
                const response = await fetch(API_CONFIG.workerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agence: agence,
                        clients: clients,
                        userEmail: userName + '@ol.com',
                        userName: userName
                    })
                });

                console.log('üì• Status HTTP:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ R√©ponse import:', result);
                
                if (result.success) {
                    showNotification('‚úÖ Import r√©ussi vers Google Sheets !', 'success');
                } else {
                    showNotification('‚ö†Ô∏è Import partiel : ' + result.message, 'warning');
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå Erreur import:', error);
                showNotification('‚ùå Erreur import : ' + error.message, 'error');
                return { success: false, message: error.message };
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'save-indicator';
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'error') {
                notification.style.background = '#ef4444';
            } else if (type === 'warning') {
                notification.style.background = '#f59e0b';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ============================================
        // ANALYSE & CALCULS
        // ============================================
        function analyzeWorkbook(workbook) {
            const allData = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false});
                
                for (let i = 2; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || !row[0] || row.length < 9) continue;
                    
                    const compte = String(row[0]).trim();
                    const nom = String(row[1]).trim();
                    const tranche120Plus = parseFloat(row[2]) || 0;
                    const tranche90_119 = parseFloat(row[3]) || 0;
                    const tranche60_89 = parseFloat(row[4]) || 0;
                    const tranche30_59 = parseFloat(row[5]) || 0;
                    const tranche0_29 = parseFloat(row[6]) || 0;
                    const paiement = parseFloat(row[7]) || 0;
                    const solde = parseFloat(row[8]) || 0;
                    
                    let totalMontant = tranche120Plus + tranche90_119 + tranche60_89 + tranche30_59 + tranche0_29;
                    let soldeGt120 = 0, solde90_119 = 0, solde60_89 = 0, solde30_59 = 0, solde0_29 = 0;
                    
                    if (totalMontant > 0 && solde > 0) {
                        const ratio = solde / totalMontant;
                        soldeGt120 = tranche120Plus * ratio;
                        solde90_119 = tranche90_119 * ratio;
                        solde60_89 = tranche60_89 * ratio;
                        solde30_59 = tranche30_59 * ratio;
                        solde0_29 = tranche0_29 * ratio;
                    } else if (solde > 0) {
                        solde0_29 = solde;
                    }
                    
                    const processedRow = {
                        codeClient: compte,
                        nomClient: nom,
                        agence: sheetName,
                        solde: solde,
                        soldeGt120: soldeGt120,
                        solde90_119: solde90_119,
                        solde60_89: solde60_89,
                        solde30_59: solde30_59,
                        solde0_29: solde0_29,
                        montantCritique: soldeGt120 + solde90_119,
                        montantRisque: soldeGt120 + solde90_119 + solde60_89,
                        pourcentageAncien: solde > 0 ? ((soldeGt120 + solde90_119 + solde60_89) / solde) * 100 : 0
                    };
                    
                    if (processedRow.solde !== 0) {
                        allData.push(processedRow);
                    }
                }
            });

            allDataGlobal = [...allData];
            const summary = calculateSummary(allData);
            return { allData, summary };
        }
        
        function calculateSummary(data) {
            const summary = {
                soldesDebiteurs: 0, soldesCrediteurs: 0, balanceTotale: 0,
                count: data.length, countCritical: 0, montantRisque: 0,
                soldeParAnciennete: { gt120: 0, between90_119: 0, between60_89: 0, between30_59: 0, lt30: 0 },
                topRisks: [], clientsCritiques: []
            };

            data.forEach(row => {
                if (row.solde > 0) summary.soldesDebiteurs += row.solde;
                else summary.soldesCrediteurs += row.solde;

                summary.soldeParAnciennete.gt120 += row.soldeGt120;
                summary.soldeParAnciennete.between90_119 += row.solde90_119;
                summary.soldeParAnciennete.between60_89 += row.solde60_89;
                summary.soldeParAnciennete.between30_59 += row.solde30_59;
                summary.soldeParAnciennete.lt30 += row.solde0_29;

                if (row.montantCritique > 0) {
                    summary.countCritical++;
                    summary.clientsCritiques.push({ 
                        code: row.codeClient, 
                        nom: row.nomClient, 
                        montantCritique: row.montantCritique 
                    });
                }
                summary.montantRisque += row.montantRisque;
            });

            summary.balanceTotale = summary.soldesDebiteurs + summary.soldesCrediteurs;
            summary.tauxRisque = summary.soldesDebiteurs > 0 ? (summary.montantRisque / summary.soldesDebiteurs) * 100 : 0;
            
            summary.topRisks = data
                .filter(r => r.solde > 0)
                .sort((a, b) => b.montantRisque - a.montantRisque)
                .slice(0, 10);
                
            return summary;
        }

        function calculateTauxImpaye() {
            const caInput = document.getElementById('chiffreAffaires');
            const ca = parseFloat(caInput.value);
            const resultDiv = document.getElementById('tauxImpayeResult');
            const valueDiv = document.getElementById('tauxImpayeValue');
            const statusDiv = document.getElementById('tauxImpayeStatus');

            if (!ca || ca <= 0 || !analysisData) {
                alert("Veuillez entrer un chiffre d'affaires valide et charger un fichier.");
                return;
            }

            const montantRisque = analysisData.summary.montantRisque;
            const taux = (montantRisque / ca) * 100;

            resultDiv.classList.remove('hidden');
            valueDiv.textContent = taux.toFixed(2) + '%';

            if (taux < 2) {
                valueDiv.className = 'text-2xl font-bold text-green-600';
                statusDiv.textContent = '‚úÖ Excellent ! Objectif atteint.';
                statusDiv.className = 'text-xs mt-1 text-green-600 font-semibold';
            } else if (taux <= 2.5) {
                valueDiv.className = 'text-2xl font-bold text-orange-600';
                statusDiv.textContent = '‚ö†Ô∏è L√©g√®rement au-dessus de l\'objectif';
                statusDiv.className = 'text-xs mt-1 text-orange-600 font-semibold';
            } else {
                valueDiv.className = 'text-2xl font-bold text-red-600';
                statusDiv.textContent = 'üö® Action urgente requise !';
                statusDiv.className = 'text-xs mt-1 text-red-600 font-semibold';
            }
        }

        // ============================================
        // AFFICHAGE & INTERFACE
        // ============================================
        function displayResults(data) {
            const summary = data.summary;
            document.getElementById('soldesDebiteurs').textContent = formatCurrency(summary.soldesDebiteurs);
            document.getElementById('soldesCrediteurs').textContent = formatCurrency(summary.soldesCrediteurs);
            document.getElementById('balanceTotale').textContent = formatCurrency(summary.balanceTotale);
            document.getElementById('nombreClients').textContent = summary.count + ' clients';
            document.getElementById('clientsCritiques').textContent = summary.countCritical + ' clients';
            document.getElementById('montantRisque').textContent = formatCurrency(summary.montantRisque);
            document.getElementById('tauxRisque').textContent = summary.tauxRisque.toFixed(1) + '%';
            
            createAgeChart(summary);
            createRiskChart(summary.topRisks);
            fillDetailsTable(data.allData);
            generateRecommendations(data);
            setupFilters(data.allData);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => { indicator.style.display = 'none'; }, 2000);
        }

        function createAgeChart(summary) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            if (ageChart) ageChart.destroy();
            const data = summary.soldeParAnciennete;
            ageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['> 120 jours', '90-119 jours', '60-89 jours', '30-59 jours', '< 30 jours'],
                    datasets: [{
                        data: [data.gt120, data.between90_119, data.between60_89, data.between30_59, data.lt30],
                        backgroundColor: ['#991b1b', '#ef4444', '#f59e0b', '#eab308', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRiskChart(topRisks) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            if (riskChart) riskChart.destroy();
            
            const labels = topRisks.map(r => r.nomClient.substring(0, 30));
            const dataGt90 = topRisks.map(r => r.soldeGt120 + r.solde90_119);
            const data60_90 = topRisks.map(r => r.solde60_89);
            const dataLt60 = topRisks.map(r => r.solde30_59 + r.solde0_29);
            
            riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Solde > 90 jours',
                            data: dataGt90,
                            backgroundColor: '#dc2626'
                        },
                        {
                            label: 'Solde 60-90 jours',
                            data: data60_90,
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Solde < 60 jours',
                            data: dataLt60,
                            backgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y: {
                            stacked: true
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    }
                }
            });
        }

        function fillDetailsTable(data) {
            const sortedData = [...data].sort((a, b) => sortData(a, b, currentSortColumn, currentSortDirection));
            const tbody = document.getElementById('detailsTable');
            tbody.innerHTML = '';
            
            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                let riskLevel = 'Faible', riskColor = 'green', actionText = 'Suivi normal';
                
                if (row.montantCritique > 0) {
                    riskLevel = 'Critique';
                    riskColor = 'red';
                    actionText = 'Relance urgente';
                } else if (row.solde60_89 > 0) {
                    riskLevel = '√âlev√©';
                    riskColor = 'orange';
                    actionText = 'Relance';
                } else if (row.solde30_59 > 0) {
                    riskLevel = 'Mod√©r√©';
                    riskColor = 'yellow';
                    actionText = 'Surveiller';
                }
                
                const clientComments = Array.isArray(commentsData[row.codeClient]) ? commentsData[row.codeClient] : [];
                const hasComments = clientComments.length > 0;
                const commentCount = clientComments.length;
                const commentCellClass = hasComments ? 'comment-input-cell has-comment' : 'comment-input-cell';
                const commentText = hasComments ? `üí¨ ${commentCount} commentaire${commentCount > 1 ? 's' : ''}` : '‚ûï Ajouter un commentaire';
                
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm">${row.codeClient}</td>
                    <td class="px-4 py-2 text-sm">${row.nomClient}</td>
                    <td class="px-4 py-2 text-sm text-right font-semibold ${row.solde > 0 ? 'text-red-600' : 'text-green-600'}">
                        ${formatCurrency(row.solde)}
                    </td>
                    <td class="px-4 py-2 text-sm text-right">${row.pourcentageAncien.toFixed(1)}%</td>
                    <td class="px-4 py-2 text-center">
                        <span class="px-2 py-1 text-xs rounded-full bg-${riskColor}-100 text-${riskColor}-800">
                            ${riskLevel}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-center text-sm">${actionText}</td>
                    <td class="px-4 py-2">
                        <div class="${commentCellClass}" onclick="openCommentModal('${row.codeClient}', '${row.nomClient.replace(/'/g, "\\'")}', ${row.solde})">
                            ${commentText}
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center no-print">
                                                <button onclick="openDeleteModal('${row.codeClient}', '${row.nomClient.replace(/'/g, "\\'")}', ${row.solde})" 
                                class="text-red-600 hover:text-red-800 font-bold">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function sortData(a, b, column, direction) {
            let aVal, bVal;
            switch(column) {
                case 'code': aVal = a.codeClient; bVal = b.codeClient; break;
                case 'nom': aVal = a.nomClient; bVal = b.nomClient; break;
                case 'solde': aVal = a.solde; bVal = b.solde; break;
                case 'anciennete': aVal = a.pourcentageAncien; bVal = b.pourcentageAncien; break;
                case 'risque': aVal = a.montantRisque; bVal = b.montantRisque; break;
                default: aVal = a.solde; bVal = b.solde;
            }
            
            if (typeof aVal === 'string') {
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            }
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        }

        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = column === 'solde' ? 'desc' : 'asc';
            }
            fillDetailsTable(applyFilters(allDataGlobal));
        }

        function generateRecommendations(data) {
            const summary = data.summary;
            
            // Alerte Urgent
            if (summary.countCritical > 0) {
                const montantCritique = summary.soldeParAnciennete.gt120 + summary.soldeParAnciennete.between90_119;
                document.getElementById('urgentAlert').classList.remove('hidden');
                document.getElementById('urgentTitle').textContent = `Urgent : ${summary.countCritical} clients critiques`;
                document.getElementById('urgentText').textContent = `Actions imm√©diates requises pour ${formatCurrency(montantCritique)}`;
            }

            // Alerte Taux de risque
            const pourcentageGt60 = summary.soldesDebiteurs > 0 
                ? ((summary.soldeParAnciennete.gt120 + summary.soldeParAnciennete.between90_119 + summary.soldeParAnciennete.between60_89) / summary.soldesDebiteurs) * 100
                : 0;
            
            if (pourcentageGt60 > 30) {
                document.getElementById('riskAlert').classList.remove('hidden');
                document.getElementById('riskTitle').textContent = `Taux de risque critique (${pourcentageGt60.toFixed(1)}%)`;
                document.getElementById('riskText').textContent = `${pourcentageGt60.toFixed(1)}% des soldes ont plus de 60 jours.`;
            }

            // Concentration du risque
            if (summary.topRisks.length > 0) {
                const top5Total = summary.topRisks.slice(0, 5).reduce((sum, r) => sum + r.montantRisque, 0);
                const concentration = summary.soldesDebiteurs > 0 ? (top5Total / summary.soldesDebiteurs) * 100 : 0;
                
                if (concentration > 50) {
                    document.getElementById('riskConcentrationCard').classList.remove('hidden');
                    document.getElementById('riskConcentrationText').textContent = 
                        `Les 5 plus gros d√©biteurs repr√©sentent ${formatCurrency(top5Total)} (${concentration.toFixed(1)}% du total).`;
                }
            }

            // Clients critiques √† contacter
            if (summary.clientsCritiques.length > 0) {
                document.getElementById('criticalClientsCard').classList.remove('hidden');
                document.getElementById('criticalClientsCount').textContent = 
                    `${summary.clientsCritiques.length} clients ont des soldes de plus de 90 jours :`;
                
                const listHTML = summary.clientsCritiques
                    .sort((a, b) => b.montantCritique - a.montantCritique)
                    .map(client => `<li>‚Ä¢ ${client.nom} (${client.code}) - ${formatCurrency(client.montantCritique)}</li>`)
                    .join('');
                
                document.getElementById('criticalClientsList').innerHTML = listHTML;
            }
        }

        function applyFilters(data) {
            const riskFilter = document.getElementById('riskFilter').value;
            const soldeTypeFilter = document.getElementById('soldeTypeFilter').value;
            const minBalance = parseFloat(document.getElementById('minBalance').value) || 0;

            return data.filter(row => {
                if (Math.abs(row.solde) < minBalance) return false;
                
                if (soldeTypeFilter === 'debiteur' && row.solde <= 0) return false;
                if (soldeTypeFilter === 'crediteur' && row.solde >= 0) return false;
                
                if (riskFilter === 'critical' && row.montantCritique <= 0) return false;
                if (riskFilter === 'high' && row.solde60_89 <= 0) return false;
                if (riskFilter === 'medium' && row.solde30_59 <= 0) return false;
                if (riskFilter === 'low' && (row.montantCritique > 0 || row.solde60_89 > 0 || row.solde30_59 > 0)) return false;
                
                return true;
            });
        }

        function setupFilters(data) {
            ['riskFilter', 'soldeTypeFilter', 'minBalance'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    fillDetailsTable(applyFilters(allDataGlobal));
                });
            });
        }

        // ============================================
        // EXPORT
        // ============================================
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Code Client', 'Nom Client', 'Agence', 'Solde', '>120j', '90-119j', '60-89j', '30-59j', '<30j', 'Risque', 'Commentaires']
            ];

            allDataGlobal.forEach(row => {
                const clientComments = Array.isArray(commentsData[row.codeClient]) ? commentsData[row.codeClient] : [];
                const comments = clientComments
                    .map(c => `[${c.author} - ${new Date(c.timestamp).toLocaleString('fr-FR')}] ${c.text}`)
                    .join(' | ');
                
                wsData.push([
                    row.codeClient,
                    row.nomClient,
                    row.agence,
                    row.solde,
                    row.soldeGt120,
                    row.solde90_119,
                    row.solde60_89,
                    row.solde30_59,
                    row.solde0_29,
                    row.montantRisque,
                    comments
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Analyse');
            XLSX.writeFile(wb, `Balance_Agee_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function saveAsHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Balance_Agee_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadComments();
            
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        });
    </script>
</body>
</html>

