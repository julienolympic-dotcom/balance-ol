<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Balances √Çg√©es - Olympic Location</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .comment-input-cell {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9fafb;
        }
        .comment-input-cell:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .comment-input-cell.has-comment {
            background-color: #fef3c7;
            border-color: #f59e0b;
            font-weight: 500;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            display: none;
            z-index: 2000;
        }
        .tab-button {
            padding: 12px 24px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .version-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .version-card:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Indicateur de sauvegarde -->
    <div class="save-indicator" id="saveIndicator">‚úì Sauvegarde effectu√©e</div>
    
    <!-- Indicateur de chargement -->
    <div id="loadingIndicator" class="loading fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-pulse text-4xl mb-4">‚è≥</div>
            <p class="text-lg font-semibold">Chargement en cours...</p>
        </div>
    </div>

    <!-- Modal Commentaires -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üí¨ Commentaires Client</h3>
            <div class="bg-blue-50 p-3 rounded mb-4">
                <p class="text-sm"><strong>Code:</strong> <span id="modalClientCode"></span></p>
                <p class="text-sm"><strong>Nom:</strong> <span id="modalClientName"></span></p>
                <p class="text-sm"><strong>Solde:</strong> <span id="modalClientSolde"></span></p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Historique des commentaires :</label>
                <div id="commentHistory" class="max-h-48 overflow-y-auto"></div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau commentaire :</label>
                <textarea id="newCommentText" class="w-full border rounded px-3 py-2" rows="3" placeholder="Entrez votre commentaire..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeCommentModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Annuler
                </button>
                <button onclick="saveNewComment()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- En-t√™te -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üè¶ Analyseur de Balances √Çg√©es</h1>
            <p class="text-gray-600">Olympic Location - Version Cloud avec Google Apps Script</p>
        </div>

        <!-- Navigation par onglets -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="flex border-b">
                <button class="tab-button active" onclick="switchTab('import')">üì§ Import</button>
                <button class="tab-button" onclick="switchTab('analyse')">üìä Analyse</button>
                <button class="tab-button" onclick="switchTab('versions')">üìÅ Versions</button>
                <button class="tab-button" onclick="switchTab('historique')">üìú Historique</button>
                <button class="tab-button" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
            </div>

            <!-- Onglet Import -->
            <div id="tab-import" class="tab-content active p-6">
                <h2 class="text-xl font-semibold mb-4">üì§ Charger votre fichier Excel</h2>
                
                <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 mb-2">Glissez-d√©posez votre fichier Excel ici</p>
                    <p class="text-sm text-gray-500">ou</p>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv">
                    <button onclick="document.getElementById('fileInput').click()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Parcourir
                    </button>
                </div>

                <div id="fileInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-green-800">‚úÖ <span id="fileName"></span></p>
                    <p class="text-sm text-green-600">Lignes d√©tect√©es : <span id="rowCount"></span></p>
                </div>

                <div class="flex space-x-4">
                    <button onclick="analyzeAndSaveToCloud()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        üíæ Analyser et Sauvegarder dans le Cloud
                    </button>
                    <button onclick="analyzeLocalOnly()" class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-semibold">
                        üëÅÔ∏è Analyser localement (sans sauvegarder)
                    </button>
                </div>

                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">üí° Format attendu :</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ <strong>Code Client</strong> : Identifiant unique du client</li>
                        <li>‚Ä¢ <strong>Nom Client</strong> : Raison sociale</li>
                        <li>‚Ä¢ <strong>Solde</strong> : Solde total (positif = d√©biteur, n√©gatif = cr√©diteur)</li>
                        <li>‚Ä¢ <strong>√âch√©ance 0-30j, 30-60j, 60-90j, >90j</strong> : Montants par tranche d'anciennet√©</li>
                    </ul>
                </div>
            </div>

            <!-- Onglet Analyse -->
            <div id="tab-analyse" class="tab-content p-6">
                <div id="analysisResults" class="hidden">
                    <h2 class="text-xl font-semibold mb-4">üìä R√©sultats de l'analyse</h2>
                    
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-600 mb-1">Soldes D√©biteurs</p>
                            <p class="text-2xl font-bold text-red-700" id="soldesDebiteurs">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-600 mb-1">Soldes Cr√©diteurs</p>
                            <p class="text-2xl font-bold text-green-700" id="soldesCrediteurs">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-600 mb-1">Balance Totale</p>
                            <p class="text-2xl font-bold text-blue-700" id="balanceTotale">0 ‚Ç¨</p>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <p class="text-sm text-orange-600 mb-1">Clients Critiques</p>
                            <p class="text-2xl font-bold text-orange-700" id="clientsCritiques">0</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <p class="text-sm text-purple-600 mb-1">Taux de Risque</p>
                            <p class="text-2xl font-bold text-purple-700" id="tauxRisque">0%</p>
                        </div>
                    </div>

                    <!-- Graphiques -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">R√©partition par anciennet√©</h3>
                            <canvas id="ageChart"></canvas>
                        </div>
                        <div class="bg-white border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">Top 10 clients</h3>
                            <canvas id="topClientsChart"></canvas>
                        </div>
                    </div>

                    <!-- Tableau des clients -->
                    <div class="bg-white border rounded-lg overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b">
                            <h3 class="font-semibold">Liste des clients</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Code</th>
                                        <th class="px-4 py-3 text-left">Nom</th>
                                        <th class="px-4 py-3 text-right">Solde</th>
                                        <th class="px-4 py-3 text-right">0-30j</th>
                                        <th class="px-4 py-3 text-right">30-60j</th>
                                        <th class="px-4 py-3 text-right">60-90j</th>
                                        <th class="px-4 py-3 text-right">>90j</th>
                                        <th class="px-4 py-3 text-center">Risque</th>
                                        <th class="px-4 py-3 text-center">Commentaires</th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export -->
                    <div class="mt-6 flex space-x-4">
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                            üì• Exporter en Excel
                        </button>
                        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                            üñ®Ô∏è Imprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Onglet Versions -->
            <div id="tab-versions" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">üìÅ Versions sauvegard√©es</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrer par agence :</label>
                    <select id="filterAgence" onchange="loadVersionsList()" class="border rounded px-3 py-2">
                        <option value="">Toutes les agences</option>
                        <option value="Marseille">Marseille</option>
                        <option value="Paris">Paris</option>
                        <option value="Lyon">Lyon</option>
                    </select>
                </div>
                
                <div id="versionsList"></div>
            </div>

            <!-- Onglet Historique -->
            <div id="tab-historique" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">üìú Historique des imports</h2>
                <button onclick="loadHistorique()" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    üîÑ Actualiser
                </button>
                <div id="historiqueList"></div>
            </div>

            <!-- Onglet Configuration -->
            <div id="tab-config" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>‚ö†Ô∏è Important :</strong> Configurez l'URL de votre Google Apps Script ci-dessous
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script :</label>
                        <input type="text" id="apiUrl" class="w-full border rounded px-3 py-2" placeholder="https://script.google.com/macros/s/...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Votre nom :</label>
                        <input type="text" id="userName" class="w-full border rounded px-3 py-2" placeholder="Pr√©nom Nom">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email :</label>
                        <input type="email" id="userEmail" class="w-full border rounded px-3 py-2" placeholder="email@example.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Agence :</label>
                        <select id="userAgence" class="w-full border rounded px-3 py-2">
                            <option value="">S√©lectionner...</option>
                            <option value="Marseille">Marseille</option>
                            <option value="Paris">Paris</option>
                            <option value="Lyon">Lyon</option>
                        </select>
                    </div>
                    
                    <button onclick="saveConfig()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        üíæ Enregistrer la configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let currentData = [];
        let clientComments = {};
        let currentClientForComment = null;
        let ageChartInstance = null;
        let topClientsChartInstance = null;
        let API_URL = '';

        // ========== INITIALISATION ==========
        window.onload = function() {
            loadConfig();
            loadCommentsFromLocalStorage();
            setupFileHandlers();
            
            // Charger les versions au d√©marrage
            if (API_URL) {
                loadVersionsList();
            }
        };

        // ========== CONFIGURATION ==========
        function loadConfig() {
            const config = localStorage.getItem('olConfig');
            if (config) {
                const data = JSON.parse(config);
                document.getElementById('apiUrl').value = data.apiUrl || '';
                document.getElementById('userName').value = data.userName || '';
                document.getElementById('userEmail').value = data.email || '';
                document.getElementById('userAgence').value = data.agence || '';
                API_URL = data.apiUrl || '';
            }
        }

        function saveConfig() {
            const config = {
                apiUrl: document.getElementById('apiUrl').value.trim(),
                userName: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                agence: document.getElementById('userAgence').value
            };
            
            if (!config.apiUrl) {
                alert('‚ùå Veuillez saisir l\'URL de votre Google Apps Script');
                return;
            }
            
            localStorage.setItem('olConfig', JSON.stringify(config));
            API_URL = config.apiUrl;
            alert('‚úÖ Configuration enregistr√©e !');
            showSaveIndicator();
        }

        function getConfig() {
            const config = localStorage.getItem('olConfig');
            return config ? JSON.parse(config) : {};
        }

        // ========== GESTION DES ONGLETS ==========
        function switchTab(tabName) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet s√©lectionn√©
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Charger les donn√©es si n√©cessaire
            if (tabName === 'versions') {
                loadVersionsList();
            } else if (tabName === 'historique') {
                loadHistorique();
            }
        }

        // ========== GESTION DES FICHIERS ==========
        function setupFileHandlers() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }

        function handleFile(file) {
            console.log('üìÅ Fichier charg√©:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('üìä Donn√©es brutes:', jsonData.slice(0, 5));
                    
                    currentData = parseExcelData(jsonData);
                    
                    if (currentData.length === 0) {
                        alert('‚ùå Aucune donn√©e d√©tect√©e. V√©rifiez les colonnes de votre fichier.');
                        return;
                    }
                    
                    console.log('‚úÖ Donn√©es pars√©es:', currentData.slice(0, 3));
                    
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('rowCount').textContent = currentData.length;
                    
                } catch (error) {
                    console.error('‚ùå Erreur:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier : ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelData(data) {
            if (data.length < 2) return [];
            
            const headers = data[0].map(h => String(h).toLowerCase().trim());
            console.log('üìã En-t√™tes d√©tect√©s:', headers);
            
            // Recherche flexible des colonnes
            const codeIndex = headers.findIndex(h => h.includes('code') || h.includes('client'));
            const nomIndex = headers.findIndex(h => h.includes('nom') || h.includes('raison'));
            const soldeIndex = headers.findIndex(h => h.includes('solde') && !h.includes('√©ch√©ance'));
            const e0Index = headers.findIndex(h => h.includes('0') || h.includes('courant'));
            const e30Index = headers.findIndex(h => h.includes('30'));
            const e60Index = headers.findIndex(h => h.includes('60'));
            const e90Index = headers.findIndex(h => h.includes('90') || h.includes('120') || h.includes('+'));
            
            console.log('üîç Index trouv√©s:', { codeIndex, nomIndex, soldeIndex, e0Index, e30Index, e60Index, e90Index });
            
            if (codeIndex === -1 || nomIndex === -1 || soldeIndex === -1) {
                console.error('‚ùå Colonnes manquantes');
                return [];
            }
            
            return data.slice(1).map(row => {
                const codeClient = row[codeIndex];
                const nomClient = row[nomIndex];
                const solde = parseFloat(row[soldeIndex] || 0);
                const echeance0 = parseFloat(row[e0Index] || 0);
                const echeance30 = parseFloat(row[e30Index] || 0);
                const echeance60 = parseFloat(row[e60Index] || 0);
                const echeance90 = parseFloat(row[e90Index] || 0);
                
                return {
                    codeClient: String(codeClient).trim(),
                    nomClient: String(nomClient).trim(),
                    solde: solde,
                    echeance0: echeance0,
                    echeance30: echeance30,
                    echeance60: echeance60,
                    echeance90: echeance90,
                    echeancePlus120: 0
                };
            }).filter(client => client.codeClient && client.nomClient);
        }

        // ========== ANALYSE ET SAUVEGARDE ==========
        async function analyzeAndSaveToCloud() {
            if (currentData.length === 0) {
                alert('‚ùå Veuillez d\'abord charger un fichier Excel');
                return;
            }

            const config = getConfig();
            if (!config.userName || !config.email || !config.agence) {
                alert('‚ùå Veuillez d\'abord configurer vos informations (nom, email, agence)');
                switchTab('config');
                return;
            }

            if (!API_URL) {
                alert('‚ùå Veuillez configurer l\'URL de votre Google Apps Script');
                switchTab('config');
                return;
            }

            document.getElementById('loadingIndicator').classList.add('active');

            try {
                const payload = {
                    action: 'importerBalance',
                    data: currentData,
                    agence: config.agence,
                    email: config.email,
                    nom: config.userName
                };
                
                console.log('üì§ Envoi vers API...');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                                              body: JSON.stringify(payload)
                      });
                      
                      console.log('‚úÖ Donn√©es envoy√©es au serveur');
                      
                      // Avec no-cors, on ne peut pas lire la r√©ponse, donc on suppose que √ßa a march√©
                      showSaveIndicator();
                      alert('‚úÖ Balance sauvegard√©e avec succ√®s dans le cloud !');
                      
                      // Afficher l'analyse locale
                      analyzeLocalOnly();
                      
                      // Recharger la liste des versions
                      setTimeout(() => loadVersionsList(), 1000);
                      
                  } catch (error) {
                      console.error('‚ùå Erreur:', error);
                      alert('‚ùå Erreur lors de la sauvegarde : ' + error.message);
                  } finally {
                      document.getElementById('loadingIndicator').classList.remove('active');
                  }
              }

              function analyzeLocalOnly() {
                  if (currentData.length === 0) {
                      alert('‚ùå Veuillez d\'abord charger un fichier Excel');
                      return;
                  }

                  // Calculs
                  const soldesDebiteurs = currentData.filter(c => c.solde > 0).reduce((sum, c) => sum + c.solde, 0);
                  const soldesCrediteurs = Math.abs(currentData.filter(c => c.solde < 0).reduce((sum, c) => sum + c.solde, 0));
                  const balanceTotale = soldesDebiteurs - soldesCrediteurs;
                  const clientsCritiques = currentData.filter(c => c.echeance90 > 1000 || c.solde > 10000).length;
                  const tauxRisque = soldesDebiteurs > 0 ? ((currentData.reduce((sum, c) => sum + c.echeance90, 0) / soldesDebiteurs) * 100).toFixed(1) : 0;

                  // Afficher les KPIs
                  document.getElementById('soldesDebiteurs').textContent = formatCurrency(soldesDebiteurs);
                  document.getElementById('soldesCrediteurs').textContent = formatCurrency(soldesCrediteurs);
                  document.getElementById('balanceTotale').textContent = formatCurrency(balanceTotale);
                  document.getElementById('clientsCritiques').textContent = clientsCritiques;
                  document.getElementById('tauxRisque').textContent = tauxRisque + '%';

                  // Afficher le tableau
                  displayClientsTable();

                  // Afficher les graphiques
                  displayCharts();

                  // Afficher la section r√©sultats
                  document.getElementById('analysisResults').classList.remove('hidden');
                  
                  // Basculer vers l'onglet analyse
                  switchTab('analyse');
              }

              function displayClientsTable() {
                  const tbody = document.getElementById('clientsTableBody');
                  tbody.innerHTML = '';

                  // Trier par solde d√©croissant
                  const sortedData = [...currentData].sort((a, b) => b.solde - a.solde);

                  sortedData.forEach(client => {
                      const row = document.createElement('tr');
                      row.className = 'border-b hover:bg-gray-50';

                      // D√©terminer le niveau de risque
                      let risqueClass = 'bg-green-100 text-green-800';
                      let risqueText = 'Faible';
                      if (client.echeance90 > 5000 || client.solde > 20000) {
                          risqueClass = 'bg-red-100 text-red-800';
                          risqueText = '√âlev√©';
                      } else if (client.echeance60 > 3000 || client.solde > 10000) {
                          risqueClass = 'bg-orange-100 text-orange-800';
                          risqueText = 'Moyen';
                      }

                      // V√©rifier si le client a des commentaires
                      const hasComments = clientComments[client.codeClient] && clientComments[client.codeClient].length > 0;
                      const commentClass = hasComments ? 'has-comment' : '';
                      const commentText = hasComments ? `üí¨ ${clientComments[client.codeClient].length}` : '‚ûï Ajouter';

                      row.innerHTML = `
                          <td class="px-4 py-3 font-mono text-sm">${client.codeClient}</td>
                          <td class="px-4 py-3">${client.nomClient}</td>
                          <td class="px-4 py-3 text-right font-semibold ${client.solde > 0 ? 'text-red-600' : 'text-green-600'}">
                              ${formatCurrency(client.solde)}
                          </td>
                          <td class="px-4 py-3 text-right">${formatCurrency(client.echeance0)}</td>
                          <td class="px-4 py-3 text-right">${formatCurrency(client.echeance30)}</td>
                          <td class="px-4 py-3 text-right">${formatCurrency(client.echeance60)}</td>
                          <td class="px-4 py-3 text-right">${formatCurrency(client.echeance90)}</td>
                          <td class="px-4 py-3 text-center">
                              <span class="px-2 py-1 rounded text-xs font-semibold ${risqueClass}">${risqueText}</span>
                          </td>
                          <td class="px-4 py-3 text-center">
                              <div class="comment-input-cell ${commentClass}" onclick="openCommentModal('${client.codeClient}', '${client.nomClient}', ${client.solde})">
                                  ${commentText}
                              </div>
                          </td>
                      `;
                      tbody.appendChild(row);
                  });
              }

              function displayCharts() {
                  // Graphique par anciennet√©
                  const totalE0 = currentData.reduce((sum, c) => sum + c.echeance0, 0);
                  const totalE30 = currentData.reduce((sum, c) => sum + c.echeance30, 0);
                  const totalE60 = currentData.reduce((sum, c) => sum + c.echeance60, 0);
                  const totalE90 = currentData.reduce((sum, c) => sum + c.echeance90, 0);

                  const ctxAge = document.getElementById('ageChart').getContext('2d');
                  if (ageChartInstance) ageChartInstance.destroy();
                  ageChartInstance = new Chart(ctxAge, {
                      type: 'doughnut',
                      data: {
                          labels: ['0-30j', '30-60j', '60-90j', '>90j'],
                          datasets: [{
                              data: [totalE0, totalE30, totalE60, totalE90],
                              backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#7c3aed']
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: true,
                          plugins: {
                              legend: { position: 'bottom' }
                          }
                      }
                  });

                  // Top 10 clients
                  const top10 = [...currentData]
                      .filter(c => c.solde > 0)
                      .sort((a, b) => b.solde - a.solde)
                      .slice(0, 10);

                  const ctxTop = document.getElementById('topClientsChart').getContext('2d');
                  if (topClientsChartInstance) topClientsChartInstance.destroy();
                  topClientsChartInstance = new Chart(ctxTop, {
                      type: 'bar',
                      data: {
                          labels: top10.map(c => c.nomClient.substring(0, 20)),
                          datasets: [{
                              label: 'Solde (‚Ç¨)',
                              data: top10.map(c => c.solde),
                              backgroundColor: '#3b82f6'
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: true,
                          indexAxis: 'y',
                          plugins: {
                              legend: { display: false }
                          },
                          scales: {
                              x: {
                                  beginAtZero: true,
                                  ticks: {
                                      callback: function(value) {
                                          return formatCurrency(value);
                                      }
                                  }
                              }
                          }
                      }
                  });
              }

              // ========== GESTION DES COMMENTAIRES ==========
              function openCommentModal(codeClient, nomClient, solde) {
                  currentClientForComment = codeClient;
                  
                  document.getElementById('modalClientCode').textContent = codeClient;
                  document.getElementById('modalClientName').textContent = nomClient;
                  document.getElementById('modalClientSolde').textContent = formatCurrency(solde);
                  
                  // Charger l'historique des commentaires
                  displayCommentHistory(codeClient);
                  
                  // Vider le champ de nouveau commentaire
                  document.getElementById('newCommentText').value = '';
                  
                  // Pr√©-remplir le nom de l'auteur
                  const config = getConfig();
                  document.getElementById('commentAuthor').value = config.userName || '';
                  
                  document.getElementById('commentModal').classList.add('active');
              }

              function closeCommentModal() {
                  document.getElementById('commentModal').classList.remove('active');
                  currentClientForComment = null;
              }

              function displayCommentHistory(codeClient) {
                  const historyDiv = document.getElementById('commentHistory');
                  const comments = clientComments[codeClient] || [];
                  
                  if (comments.length === 0) {
                      historyDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun commentaire pour ce client</p>';
                      return;
                  }
                  
                  historyDiv.innerHTML = comments.map((comment, index) => `
                      <div class="comment-history-item">
                          <button class="comment-delete-btn" onclick="deleteComment('${codeClient}', ${index})">üóëÔ∏è</button>
                          <div class="author">${comment.author}</div>
                          <div class="timestamp">${new Date(comment.timestamp).toLocaleString('fr-FR')}</div>
                          <div class="text">${comment.text}</div>
                      </div>
                  `).join('');
              }

              function saveNewComment() {
                  const author = document.getElementById('commentAuthor').value.trim();
                  const text = document.getElementById('newCommentText').value.trim();
                  
                  if (!author) {
                      alert('‚ùå Veuillez saisir votre nom');
                      return;
                  }
                  
                  if (!text) {
                      alert('‚ùå Veuillez saisir un commentaire');
                      return;
                  }
                  
                  if (!clientComments[currentClientForComment]) {
                      clientComments[currentClientForComment] = [];
                  }
                  
                  clientComments[currentClientForComment].push({
                      author: author,
                      text: text,
                      timestamp: new Date().toISOString()
                  });
                  
                  // Sauvegarder dans localStorage
                  saveCommentsToLocalStorage();
                  
                  // Sauvegarder dans le cloud
                  saveCommentToCloud(currentClientForComment, author, text);
                  
                  // Actualiser l'affichage
                  displayCommentHistory(currentClientForComment);
                  displayClientsTable();
                  
                  // Vider le champ
                  document.getElementById('newCommentText').value = '';
                  
                  showSaveIndicator();
              }

              function deleteComment(codeClient, index) {
                  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?')) {
                      return;
                  }
                  
                  clientComments[codeClient].splice(index, 1);
                  
                  if (clientComments[codeClient].length === 0) {
                      delete clientComments[codeClient];
                  }
                  
                  saveCommentsToLocalStorage();
                  displayCommentHistory(codeClient);
                  displayClientsTable();
                  
                  showSaveIndicator();
              }

              async function saveCommentToCloud(codeClient, author, text) {
                  if (!API_URL) return;
                  
                  try {
                      const config = getConfig();
                      const payload = {
                          action: 'ajouterCommentaire',
                          codeClient: codeClient,
                          commentaire: text,
                          auteur: author,
                          agence: config.agence
                      };
                      
                      await fetch(API_URL, {
                          method: 'POST',
                          mode: 'no-cors',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify(payload)
                      });
                      
                      console.log('‚úÖ Commentaire sauvegard√© dans le cloud');
                  } catch (error) {
                      console.error('‚ùå Erreur sauvegarde commentaire:', error);
                  }
              }

              function saveCommentsToLocalStorage() {
                  localStorage.setItem('olClientComments', JSON.stringify(clientComments));
              }

              function loadCommentsFromLocalStorage() {
                  const saved = localStorage.getItem('olClientComments');
                  if (saved) {
                      clientComments = JSON.parse(saved);
                  }
              }

              // ========== GESTION DES VERSIONS ==========
              async function loadVersionsList() {
                  if (!API_URL) {
                      document.getElementById('versionsList').innerHTML = `
                          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                              <p class="text-yellow-800">‚ö†Ô∏è Veuillez configurer l'URL de votre Google Apps Script</p>
                          </div>
                      `;
                      return;
                  }
                  
                  document.getElementById('loadingIndicator').classList.add('active');
                  
                  try {
                      const filterAgence = document.getElementById('filterAgence').value;
                      
                      const payload = {
                          action: 'listerVersions',
                          agence: filterAgence || undefined
                      };
                      
                      const response = await fetch(API_URL + '?action=listerVersions&agence=' + encodeURIComponent(filterAgence), {
                          method: 'GET'
                      });
                      
                      const result = await response.json();
                      
                      if (result.success && result.versions) {
                          displayVersionsList(result.versions);
                      } else {
                          document.getElementById('versionsList').innerHTML = `
                              <div class="bg-gray-50 border rounded-lg p-4">
                                  <p class="text-gray-600">Aucune version trouv√©e</p>
                              </div>
                          `;
                      }
                  } catch (error) {
                      console.error('‚ùå Erreur chargement versions:', error);
                      document.getElementById('versionsList').innerHTML = `
                          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                              <p class="text-red-800">‚ùå Erreur lors du chargement des versions</p>
                          </div>
                      `;
                  } finally {
                      document.getElementById('loadingIndicator').classList.remove('active');
                  }
              }

              function displayVersionsList(versions) {
                  const container = document.getElementById('versionsList');
                  
                  if (versions.length === 0) {
                      container.innerHTML = `
                          <div class="bg-gray-50 border rounded-lg p-4">
                              <p class="text-gray-600">Aucune version trouv√©e</p>
                          </div>
                      `;
                      return;
                  }
                  
                  container.innerHTML = versions.map(version => `
                      <div class="version-card" onclick="loadVersion('${version.id}')">
                          <div class="flex justify-between items-start mb-2">
                              <div>
                                  <h3 class="font-semibold text-lg">${version.agence || 'Non sp√©cifi√©'}</h3>
                                  <p class="text-sm text-gray-600">Par ${version.auteur || 'Inconnu'}</p>
                              </div>
                              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                  ${new Date(version.date).toLocaleDateString('fr-FR')}
                              </span>
                          </div>
                          <div class="grid grid-cols-3 gap-2 text-sm">
                              <div>
                                  <span class="text-gray-600">Clients:</span>
                                  <span class="font-semibold ml-1">${version.nbClients || 0}</span>
                              </div>
                              <div>
                                  <span class="text-gray-600">Balance:</span>
                                  <span class="font-semibold ml-1">${formatCurrency(version.balanceTotale || 0)}</span>
                              </div>
                              <div>
                                  <span class="text-gray-600">Risque:</span>
                                  <span class="font-semibold ml-1">${version.tauxRisque || 0}%</span>
                              </div>
                          </div>
                      </div>
                  `).join('');
              }

              async function loadVersion(versionId) {
                  if (!confirm('Charger cette version ?')) return;
                  
                  document.getElementById('loadingIndicator').classList.add('active');
                  
                  try {
                      const response = await fetch(API_URL + '?action=chargerVersion&id=' + versionId, {
                          method: 'GET'
                      });
                      
                      const result = await response.json();
                      
                      if (result.success && result.data) {
                          currentData = result.data;
                          analyzeLocalOnly();
                          alert('‚úÖ Version charg√©e avec succ√®s !');
                      } else {
                          alert('‚ùå Erreur lors du chargement de la version');
                      }
                  } catch (error) {
                      console.error('‚ùå Erreur:', error);
                      alert('‚ùå Erreur lors du chargement : ' + error.message);
                  } finally {
                      document.getElementById('loadingIndicator').classList.remove('active');
                  }
              }

              // ========== HISTORIQUE ==========
              async function loadHistorique() {
                  if (!API_URL) {
                      document.getElementById('historiqueList').innerHTML = `
                          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                              <p class="text-yellow-800">‚ö†Ô∏è Veuillez configurer l'URL de votre Google Apps Script</p>
                          </div>
                      `;
                      return;
                  }
                  
                  document.getElementById('loadingIndicator').classList.add('active');
                  
                  try {
                      const response = await fetch(API_URL + '?action=historique', {
                          method: 'GET'
                      });
                      
                      const result = await response.json();
                      
                      if (result.success && result.historique) {
                          displayHistorique(result.historique);
                      }
                  } catch (error) {
                      console.error('‚ùå Erreur:', error);
                  } finally {
                      document.getElementById('loadingIndicator').classList.remove('active');
                  }
              }

              function displayHistorique(historique) {
                  const container = document.getElementById('historiqueList');
                  
                  if (historique.length === 0) {
                      container.innerHTML = `
                          <div class="bg-gray-50 border rounded-lg p-4">
                              <p class="text-gray-600">Aucun historique disponible</p>
                          </div>
                      `;
                      return;
                  }
                  
                  container.innerHTML = `
                      <div class="overflow-x-auto">
                          <table class="w-full text-sm">
                              <thead class="bg-gray-100">
                                  <tr>
                                      <th class="px-4 py-3 text-left">Date</th>
                                      <th class="px-4 py-3 text-left">Action</th>
                                      <th class="px-4 py-3 text-left">Utilisateur</th>
                                      <th class="px-4 py-3 text-left">Agence</th>
                                      <th class="px-4 py-3 text-left">D√©tails</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${historique.map(h => `
                                      <tr class="border-b hover:bg-gray-50">
                                          <td class="px-4 py-3">${new Date(h.date).toLocaleString('fr-FR')}</td>
                                          <td class="px-4 py-3">${h.action}</td>
                                          <td class="px-4 py-3">${h.utilisateur}</td>
                                          <td class="px-4 py-3">${h.agence}</td>
                                          <td class="px-4 py-3 text-gray-600">${h.details || '-'}</td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  `;
              }

              // ========== EXPORT ==========
              function exportToExcel() {
                  if (currentData.length === 0) {
                      alert('‚ùå Aucune donn√©e √† exporter');
                      return;
                  }
                  
                  const ws = XLSX.utils.json_to_sheet(currentData.map(c => ({
                      'Code Client': c.codeClient,
                      'Nom Client': c.nomClient,
                      'Solde': c.solde,
                      '0-30j': c.echeance0,
                      '30-60j': c.echeance30,
                      '60-90j': c.echeance60,
                      '>90j': c.echeance90,
                      'Commentaires': clientComments[c.codeClient] ? clientComments[c.codeClient].length : 0
                  })));
                  
                  const wb = XLSX.utils.book_new();
                  XLSX.utils.book_append_sheet(wb, ws, 'Balance √Çg√©e');
                  
                  const fileName = `Balance_Agee_${new Date().toISOString().split('T')[0]}.xlsx`;
                  XLSX.writeFile(wb, fileName);
              }

              // ========== UTILITAIRES ==========
              function formatCurrency(value) {
                  return new Intl.NumberFormat('fr-FR', {
                      style: 'currency',
                      currency: 'EUR'
                  }).format(value);
              }

              function showSaveIndicator() {
                  const indicator = document.getElementById('saveIndicator');
                  indicator.style.display = 'block';
                  setTimeout(() => {
                      indicator.style.display = 'none';
                  }, 2000);
              }
          </script>
      </body>
      </html>
