<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Balance √Çg√©e - Olympic Location</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .tab-active {
      background-color: #3b82f6;
      color: white;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .table-container {
      max-height: 600px;
      overflow-y: auto;
    }
    .sticky-header th {
      position: sticky;
      top: 0;
      background-color: #1e40af;
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">üìä Balance √Çg√©e</h1>
          <p class="text-blue-200 text-sm">Olympic Location - Gestion des cr√©ances clients</p>
        </div>
        <div id="userInfo" class="text-right hidden">
          <p class="font-semibold" id="userName"></p>
          <p class="text-sm text-blue-200" id="userEmail"></p>
          <button onclick="logout()" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded text-sm">
            D√©connexion
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTAINER -->
  <div class="container mx-auto px-4 py-8">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê Connexion</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="emailInput" placeholder="votre.email@olympiclocation.fr"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button onclick="login()" 
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
          Se connecter
        </button>
        <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
      
      <!-- TABS -->
      <div class="bg-white rounded-lg shadow-lg mb-6">
        <div class="flex border-b">
          <button onclick="switchTab('import')" id="tab-import" 
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition tab-active">
            üì§ Import
          </button>
          <button onclick="switchTab('consultation')" id="tab-consultation"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            üìã Consultation
          </button>
          <button onclick="switchTab('historique')" id="tab-historique"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            üìú Historique
          </button>
          <button onclick="switchTab('config')" id="tab-config"
            class="flex-1 py-4 px-6 font-semibold text-gray-700 hover:bg-gray-50 transition">
            ‚öôÔ∏è Configuration
          </button>
        </div>
      </div>

      <!-- TAB CONTENT: IMPORT -->
      <div id="content-import" class="tab-content">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üì§ Import de Balance</h2>
          
          <div class="space-y-6">
            <!-- S√©lection agence -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
              <select id="agenceSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">-- S√©lectionnez une agence --</option>
              </select>
            </div>

            <!-- Upload fichier -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fichier Excel</label>
              <input type="file" id="fileInput" accept=".xlsx,.xls" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Bouton import -->
            <button onclick="importerFichier()" 
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
              üöÄ Importer
            </button>

            <!-- Messages -->
            <div id="importMessage" class="hidden"></div>
            
            <!-- Loader -->
            <div id="importLoader" class="hidden flex justify-center items-center py-8">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: CONSULTATION -->
      <div id="content-consultation" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Consultation des Balances</h2>
          
          <div class="space-y-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Agence</label>
                <select id="consultAgenceSelect" onchange="chargerVersions()" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">-- S√©lectionnez une agence --</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                <select id="versionSelect" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="latest">Derni√®re version</option>
                </select>
              </div>
            </div>
            
            <button onclick="chargerBalance()" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
              üìä Charger la balance
            </button>
          </div>

          <!-- R√©sultats -->
          <div id="balanceResults" class="hidden">
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                  <p class="text-sm text-gray-600">Version</p>
                  <p class="text-xl font-bold text-blue-700" id="resultVersion"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Date</p>
                  <p class="text-xl font-bold text-blue-700" id="resultDate"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Clients</p>
                  <p class="text-xl font-bold text-blue-700" id="resultNbClients"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Solde Total</p>
                  <p class="text-xl font-bold text-blue-700" id="resultSoldeTotal"></p>
                </div>
              </div>
            </div>

            <!-- Recherche -->
            <div class="mb-4">
              <input type="text" id="searchInput" placeholder="üîç Rechercher un client..." 
                onkeyup="filtrerClients()"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Tableau -->
            <div class="table-container border rounded-lg">
              <table class="w-full text-sm">
                <thead class="sticky-header text-white">
                  <tr>
                    <th class="px-4 py-3 text-left">Code</th>
                    <th class="px-4 py-3 text-left">Client</th>
                    <th class="px-4 py-3 text-right">Solde</th>
                    <th class="px-4 py-3 text-right">0-29j</th>
                    <th class="px-4 py-3 text-right">30-59j</th>
                    <th class="px-4 py-3 text-right">60-89j</th>
                    <th class="px-4 py-3 text-right">90-119j</th>
                    <th class="px-4 py-3 text-right">+120j</th>
                    <th class="px-4 py-3 text-right">Paiement</th>
                  </tr>
                </thead>
                <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>

          <div id="consultLoader" class="hidden flex justify-center items-center py-8">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: HISTORIQUE -->
      <div id="content-historique" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìú Historique des Imports</h2>
          
          <button onclick="chargerHistorique()" 
            class="mb-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition duration-200">
            üîÑ Actualiser
          </button>

          <div id="historiqueContent" class="space-y-2">
            <!-- Historique dynamique -->
          </div>

          <div id="historiqueLoader" class="hidden flex justify-center items-center py-8">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- TAB CONTENT: CONFIG -->
      <div id="content-config" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Configuration</h2>
          
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">URL de l'API Google Apps Script</label>
              <input type="text" id="apiUrlInput" 
                placeholder="https://script.google.com/macros/s/..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex gap-4">
              <button onclick="sauvegarderConfig()" 
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                üíæ Sauvegarder
              </button>
              <button onclick="testerConnexion()" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                üîå Tester la connexion
              </button>
            </div>

            <div id="configMessage" class="hidden"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION GLOBALE
    // ============================================
    let API_URL = 'https://twilight-resonance-5291.julienolympic.workers.dev';
    let currentUser = null;
    let currentBalance = [];

    const AGENCES_MAP = {
      '00': 'G√®ze',
      '01': '5 Av',
      '02': 'Gare St Charles',
      '03': 'Aubagne',
      '06': 'La Valentine',
      '09': 'Plombi√®res',
      '12': 'La Garde',
      '13': 'La Ciotat',
      '08': 'Toulon'
    };

    // ============================================
    // INITIALISATION
    // ============================================
    window.onload = function() {
      console.log('üöÄ Application d√©marr√©e');
      
      // Charger config
      const savedUrl = localStorage.getItem('apiUrl');
      if (savedUrl) {
        API_URL = savedUrl;
        document.getElementById('apiUrlInput').value = savedUrl;
      }

      // V√©rifier session
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        afficherMainApp();
      }
    };

    // ============================================
    // AUTHENTIFICATION
    // ============================================
    async function login() {
      const email = document.getElementById('emailInput').value.trim();
      
      if (!email) {
        showError('loginError', 'Veuillez entrer votre email');
        return;
      }

      try {
        const response = await fetch(`${API_URL}?action=authentifier&email=${encodeURIComponent(email)}`);
        const data = await response.json();

        if (data.success) {
          currentUser = data;
          localStorage.setItem('currentUser', JSON.stringify(data));
          afficherMainApp();
        } else {
          showError('loginError', data.message || 'Email non autoris√©');
        }
      } catch (error) {
        console.error('Erreur login:', error);
        showError('loginError', 'Erreur de connexion : ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
    }

    function afficherMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.nom;
      document.getElementById('userEmail').textContent = currentUser.email;

      // Remplir les selects d'agences
      remplirAgences();
    }

    function remplirAgences() {
      const agences = currentUser.agencesArray || [];
      const select1 = document.getElementById('agenceSelect');
      const select2 = document.getElementById('consultAgenceSelect');

      select1.innerHTML = '<option value="">-- S√©lectionnez une agence --</option>';
      select2.innerHTML = '<option value="">-- S√©lectionnez une agence --</option>';

      agences.forEach(code => {
        const nom = AGENCES_MAP[code] || code;
        select1.innerHTML += `<option value="${code}">${code} - ${nom}</option>`;
        select2.innerHTML += `<option value="${code}">${code} - ${nom}</option>`;
      });
    }

    // ============================================
    // GESTION DES ONGLETS
    // ============================================
    function switchTab(tabName) {
      console.log('Switching to tab:', tabName);
      
      // D√©sactiver tous les onglets
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));

      // Activer l'onglet s√©lectionn√©
      document.getElementById('content-' + tabName).classList.remove('hidden');
      document.getElementById('tab-' + tabName).classList.add('tab-active');
    }

    // ============================================
    // IMPORT DE FICHIER
    // ============================================
    async function importerFichier() {
      const agence = document.getElementById('agenceSelect').value;
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!agence) {
        showMessage('importMessage', 'Veuillez s√©lectionner une agence', 'error');
        return;
      }

      if (!file) {
        showMessage('importMessage', 'Veuillez s√©lectionner un fichier', 'error');
        return;
      }

      document.getElementById('importLoader').classList.remove('hidden');
      document.getElementById('importMessage').classList.add('hidden');

      try {
        const data = await lireFichierExcel(file);
        console.log('üìä Donn√©es brutes Excel:', data);

        if (!data || !data.clients || data.clients.length === 0) {
          throw new Error('Aucune donn√©e valide trouv√©e dans le fichier');
        }

        console.log('üì§ Envoi de', data.clients.length, 'clients pour l\'agence', agence);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'import',
            data: data.clients,
            agence: agence,
            user: currentUser.email,
            metadata: {
              userName: currentUser.nom,
              dateImport: new Date().toISOString()
            }
          })
        });

        const result = await response.json();
        console.log('‚úÖ R√©ponse re√ßue:', result);

        if (result.success) {
          showMessage('importMessage', 
            `‚úÖ Import r√©ussi ! ${result.nbClients} clients import√©s (${result.version})`, 
            'success');
          fileInput.value = '';
        } else {
          showMessage('importMessage', '‚ùå ' + (result.message || 'Erreur inconnue'), 'error');
        }

      } catch (error) {
        console.error('‚ùå Erreur import:', error);
        showMessage('importMessage', '‚ùå Erreur : ' + error.message, 'error');
      } finally {
        document.getElementById('importLoader').classList.add('hidden');
      }
    }

    async function lireFichierExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        console.log('üìä Parsing Excel - Feuilles:', workbook.SheetNames);
        
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
          header: 1,
          defval: '',
          blankrows: false
        });
        
        console.log('üìä Nombre total de lignes:', jsonData.length);
        console.log('üìä Premi√®re ligne:', jsonData[0]);
        console.log('üìä Deuxi√®me ligne:', jsonData[1]);
        
        if (jsonData.length < 3) {
          reject(new Error('Fichier vide ou invalide (moins de 3 lignes)'));
          return;
        }

        // D√âTECTION AUTOMATIQUE DE LA LIGNE D'EN-T√äTES
        let headerRowIndex = 0;
        
        // Chercher la ligne qui contient "Compte" et "Intitul√©"
        for (let i = 0; i < Math.min(5, jsonData.length); i++) {
          const row = jsonData[i];
          const rowStr = row.join('|').toLowerCase();
          
          if (rowStr.includes('compte') && rowStr.includes('intitul√©')) {
            headerRowIndex = i;
            console.log('‚úÖ En-t√™tes d√©tect√©s √† la ligne', i + 1);
            break;
          }
        }

        const headers = jsonData[headerRowIndex].map(h => 
          String(h || '')
            .toLowerCase()
            .replace(/\s+/g, ' ')
            .replace(/\n/g, ' ')
            .trim()
        );
        
        console.log('üìã En-t√™tes normalis√©s:', headers);

        // MAPPING DES COLONNES
        const colonnes = {
          compte: headers.findIndex(h => 
            h.includes('compte') || h === 'compte'
          ),
          intitule: headers.findIndex(h => 
            h.includes('intitul√©') || h.includes('intitule') || h.includes('nom')
          ),
          solde: headers.findIndex(h => 
            h === 'solde' || h.includes('solde')
          ),
          e120plus: headers.findIndex(h => 
            h.includes('120') || h.includes('+120') || (h.includes('echue') && h.includes('120'))
          ),
          e90_119: headers.findIndex(h => 
            (h.includes('90') && h.includes('119')) || (h.includes('echue') && h.includes('90'))
          ),
          e60_89: headers.findIndex(h => 
            (h.includes('60') && h.includes('89')) || (h.includes('echue') && h.includes('60'))
          ),
          e30_59: headers.findIndex(h => 
            (h.includes('30') && h.includes('59')) || (h.includes('echue') && h.includes('30'))
          ),
          e0_29: headers.findIndex(h => 
            (h.includes('0') && h.includes('29')) || (h.includes('echue') && h.includes('0'))
          ),
          paiement: headers.findIndex(h => 
            h.includes('paiement')
          )
        };

        console.log('üìä Mapping des colonnes:', colonnes);

        // V√©rification des colonnes obligatoires
        if (colonnes.compte === -1) {
          reject(new Error('Colonne "Compte" non trouv√©e'));
          return;
        }
        if (colonnes.intitule === -1) {
          reject(new Error('Colonne "Intitul√©" non trouv√©e'));
          return;
        }
        if (colonnes.solde === -1) {
          reject(new Error('Colonne "Solde" non trouv√©e'));
          return;
        }

        const clients = [];
        
        // Commencer APR√àS la ligne d'en-t√™tes
        for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          
          // Ignorer les lignes vides
          if (!row || row.length === 0 || row.every(cell => !cell || cell === '')) {
            continue;
          }
          
          const compte = String(row[colonnes.compte] || '').trim();
          const intitule = String(row[colonnes.intitule] || '').trim();
          
          // Ignorer si pas de compte
          if (!compte || compte === '') {
            console.log(`‚ö†Ô∏è Ligne ${i + 1} ignor√©e: pas de compte`);
            continue;
          }

          // Parser les montants (g√©rer les valeurs n√©gatives et vides)
          const parseMontant = (val) => {
            if (!val || val === '') return 0;
            const num = parseFloat(String(val).replace(/,/g, '.').replace(/\s/g, ''));
            return isNaN(num) ? 0 : num;
          };

          const solde = parseMontant(row[colonnes.solde]);
          const e0_29 = colonnes.e0_29 !== -1 ? parseMontant(row[colonnes.e0_29]) : 0;
          const e30_59 = colonnes.e30_59 !== -1 ? parseMontant(row[colonnes.e30_59]) : 0;
          const e60_89 = colonnes.e60_89 !== -1 ? parseMontant(row[colonnes.e60_89]) : 0;
          const e90_119 = colonnes.e90_119 !== -1 ? parseMontant(row[colonnes.e90_119]) : 0;
          const e120plus = colonnes.e120plus !== -1 ? parseMontant(row[colonnes.e120plus]) : 0;
          const paiement = colonnes.paiement !== -1 ? parseMontant(row[colonnes.paiement]) : 0;

          const client = {
            code: compte,
            nom: intitule,
            solde: solde,
            e0_29: e0_29,
            e30_59: e30_59,
            e60_89: e60_89,
            e90_119: e90_119,
            e120plus: e120plus,
            paiement: paiement
          };

          console.log(`‚úÖ Client ${clients.length + 1}: ${compte} - ${intitule} - Solde: ${solde}‚Ç¨`);
          clients.push(client);
        }

        console.log('‚úÖ TOTAL:', clients.length, 'clients valides d√©tect√©s');

        if (clients.length === 0) {
          reject(new Error('Aucun client valide trouv√© dans le fichier'));
          return;
        }

        resolve({
          clients: clients,
          metadata: {
            nbLignesTotal: jsonData.length,
            nbClients: clients.length,
            headerRow: headerRowIndex + 1
          }
        });

      } catch (error) {
        console.error('‚ùå Erreur parsing Excel:', error);
        reject(error);
      }
    };

    reader.onerror = function(error) {
      reject(error);
    };

    reader.readAsArrayBuffer(file);
  });
}


    // ============================================
    // CONSULTATION
    // ============================================
    async function chargerVersions() {
      const agence = document.getElementById('consultAgenceSelect').value;
      if (!agence) return;

      try {
        const response = await fetch(`${API_URL}?action=getVersions&agence=${agence}`);
        const data = await response.json();

        const select = document.getElementById('versionSelect');
        select.innerHTML = '<option value="latest">Derni√®re version</option>';

        if (data.success && data.versions) {
          data.versions.forEach(v => {
            select.innerHTML += `<option value="${v.version}">${v.version} - ${v.date} ${v.heure} (${v.nbClients} clients)</option>`;
          });
        }
      } catch (error) {
        console.error('Erreur chargement versions:', error);
      }
    }

    async function chargerBalance() {
      const agence = document.getElementById('consultAgenceSelect').value;
      const version = document.getElementById('versionSelect').value;

      if (!agence) {
        alert('Veuillez s√©lectionner une agence');
        return;
      }

      document.getElementById('consultLoader').classList.remove('hidden');
      document.getElementById('balanceResults').classList.add('hidden');

      try {
        const response = await fetch(`${API_URL}?action=getBalance&agence=${agence}&version=${version}`);
        const data = await response.json();

        if (data.success) {
          currentBalance = data.clients;
          afficherBalance(data);
        } else {
          alert('Erreur : ' + data.message);
        }
      } catch (error) {
        console.error('Erreur chargement balance:', error);
        alert('Erreur de chargement : ' + error.message);
      } finally {
        document.getElementById('consultLoader').classList.add('hidden');
      }
    }

    function afficherBalance(data) {
      document.getElementById('resultVersion').textContent = data.version;
      document.getElementById('resultDate').textContent = data.dateImport;
      document.getElementById('resultNbClients').textContent = data.nbClients;
      
      const soldeTotal = data.clients.reduce((sum, c) => sum + (c.solde || 0), 0);
      document.getElementById('resultSoldeTotal').textContent = formatMontant(soldeTotal);

      afficherClients(data.clients);
      document.getElementById('balanceResults').classList.remove('hidden');
    }

    function afficherClients(clients) {
      const tbody = document.getElementById('clientsTableBody');
      tbody.innerHTML = '';

      clients.forEach(client => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-2 font-mono text-sm">${client.codeClient}</td>
          <td class="px-4 py-2">${client.nomClient}</td>
          <td class="px-4 py-2 text-right font-semibold">${formatMontant(client.solde)}</td>
          <td class="px-4 py-2 text-right">${formatMontant(client.echeance0)}</td>
          <td class="px-4 py-2 text-right">${formatMontant(client.echeance30)}</td>
          <td class="px-4 py-2 text-right">${formatMontant(client.echeance60)}</td>
          <td class="px-4 py-2 text-right">${formatMontant(client.echeance90)}</td>
          <td class="px-4 py-2 text-right text-red-600 font-semibold">${formatMontant(client.echeancePlus120)}</td>
          <td class="px-4 py-2 text-right text-green-600">${formatMontant(client.paiement)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filtrerClients() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = currentBalance.filter(c => 
        c.codeClient.toLowerCase().includes(search) || 
        c.nomClient.toLowerCase().includes(search)
        );
        afficherClients(filtered);
      }

      // ============================================
      // HISTORIQUE
      // ============================================
      async function chargerHistorique() {
        document.getElementById('historiqueLoader').classList.remove('hidden');
        
        try {
          const response = await fetch(`${API_URL}?action=getHistorique`);
          const data = await response.json();

          if (data.success) {
            afficherHistorique(data.historique);
          } else {
            alert('Erreur : ' + data.message);
          }
        } catch (error) {
          console.error('Erreur chargement historique:', error);
          alert('Erreur de chargement : ' + error.message);
        } finally {
          document.getElementById('historiqueLoader').classList.add('hidden');
        }
      }

      function afficherHistorique(historique) {
        const container = document.getElementById('historiqueContent');
        container.innerHTML = '';

        if (!historique || historique.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun historique disponible</p>';
          return;
        }

        historique.forEach(h => {
          const div = document.createElement('div');
          div.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <p class="font-semibold text-gray-800">
                  ${AGENCES_MAP[h.agence] || h.agence} - ${h.version}
                </p>
                <p class="text-sm text-gray-600">
                  ${h.utilisateur} (${h.email})
                </p>
                <p class="text-sm text-gray-500">
                  ${h.nbClients} clients import√©s
                </p>
              </div>
              <div class="text-right">
                <p class="text-sm font-medium text-blue-600">${h.date}</p>
                <p class="text-xs text-gray-500">${h.heure}</p>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      }

      // ============================================
      // CONFIGURATION
      // ============================================
      function sauvegarderConfig() {
        const url = document.getElementById('apiUrlInput').value.trim();
        
        if (!url) {
          showMessage('configMessage', 'Veuillez entrer une URL', 'error');
          return;
        }

        API_URL = url;
        localStorage.setItem('apiUrl', url);
        showMessage('configMessage', '‚úÖ Configuration sauvegard√©e', 'success');
      }

      async function testerConnexion() {
        const url = document.getElementById('apiUrlInput').value.trim() || API_URL;
        
        showMessage('configMessage', 'üîÑ Test en cours...', 'info');

        try {
          const response = await fetch(`${url}?action=test`);
          const data = await response.json();

          console.log('‚úÖ R√©ponse re√ßue:', data);

          if (data.status === 'success' || data.success) {
            showMessage('configMessage', '‚úÖ Connexion r√©ussie ! API op√©rationnelle', 'success');
          } else {
            showMessage('configMessage', '‚ö†Ô∏è Connexion √©tablie mais r√©ponse inattendue', 'warning');
          }
        } catch (error) {
          console.error('‚ùå Erreur test connexion:', error);
          showMessage('configMessage', '‚ùå Erreur de connexion : ' + error.message, 'error');
        }
      }

      // ============================================
      // UTILITAIRES
      // ============================================
      function formatMontant(montant) {
        if (!montant || isNaN(montant)) return '0,00 ‚Ç¨';
        return new Intl.NumberFormat('fr-FR', {
          style: 'currency',
          currency: 'EUR'
        }).format(montant);
      }

      function showMessage(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'bg-yellow-100');
        el.classList.remove('border-red-400', 'border-green-400', 'border-blue-400', 'border-yellow-400');
        el.classList.remove('text-red-700', 'text-green-700', 'text-blue-700', 'text-yellow-700');

        if (type === 'error') {
          el.className = 'p-4 rounded-lg border bg-red-100 border-red-400 text-red-700';
        } else if (type === 'success') {
          el.className = 'p-4 rounded-lg border bg-green-100 border-green-400 text-green-700';
        } else if (type === 'warning') {
          el.className = 'p-4 rounded-lg border bg-yellow-100 border-yellow-400 text-yellow-700';
        } else {
          el.className = 'p-4 rounded-lg border bg-blue-100 border-blue-400 text-blue-700';
        }

        el.textContent = message;
        el.classList.add('fade-in');
      }

      function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.classList.remove('hidden');
        el.classList.add('fade-in');
      }
    </script>
  </body>
  </html>




